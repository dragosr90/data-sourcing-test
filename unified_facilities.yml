target: int_{{ RUN_MONTH }}.{{ DELIVERY_ENTITY }}_unified_facilities

sources:
  - alias: SSF_CF
    columns:
    - DeliveryEntity
    - LocalFacilityIdentifier
    - ParentCreditFacility
    source: stg_{{ RUN_MONTH }}.ssf_{{ DELIVERY_ENTITY }}_cf
  - alias: SSF_DUMMY_FACILITY
    columns:
    - DeliveryEntity
    - LocalFacilityIdentifier
    - ParentCreditFacility
    source: int_{{ RUN_MONTH }}.{{ DELIVERY_ENTITY }}_dummy_facility

# We start with a simple filter on SSF_CF to establish it as the initial source
transformations:
  - filter:
      left_source: SSF_CF
      conditions:
        - 1=1  # Always true condition
  
  # Then union with SSF_DUMMY_FACILITY
  - union:
      alias: UNIFIED_FACILITIES
      column_mapping:
        SSF_CF:
          DeliveryEntity: DeliveryEntity
          LocalFacilityIdentifier: LocalFacilityIdentifier
          ParentCreditFacility: ParentCreditFacility
        SSF_DUMMY_FACILITY:
          DeliveryEntity: DeliveryEntity
          LocalFacilityIdentifier: LocalFacilityIdentifier
          ParentCreditFacility: ParentCreditFacility

expressions:
  DeliveryEntity: UNIFIED_FACILITIES.DeliveryEntity
  LocalFacilityIdentifier: UNIFIED_FACILITIES.LocalFacilityIdentifier
  ParentCreditFacility: UNIFIED_FACILITIES.ParentCreditFacility

drop_duplicates: true

filter_target:
- DeliveryEntity = '{{ DELIVERY_ENTITY }}'
