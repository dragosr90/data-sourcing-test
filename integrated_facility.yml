target: int_{{ RUN_MONTH }}.{{ DELIVERY_ENTITY }}_integrated_facility

sources:
  - alias: SSF_CF
    columns:
    - DeliveryEntity
    - LocalFacilityIdentifier
    - ParentCreditFacility
    source: stg_{{ RUN_MONTH }}.ssf_{{ DELIVERY_ENTITY }}_cf
  - alias: SSF_DUMMY_FACILITY
    columns:
    - DeliveryEntity
    - LocalFacilityIdentifier
    - ParentCreditFacility
    source: int_{{ RUN_MONTH }}.{{ DELIVERY_ENTITY }}_dummy_facility
  - alias: SSF_FACILITY_ROLLUP
    columns:
    - DeliveryEntity
    - LocalFacilityIdentifier
    - HighestExistingFacility
    - HighestFacilityExplained
    - SubFacilityFlag
    source: int_{{ RUN_MONTH }}.{{ DELIVERY_ENTITY }}_facility_rollup

transformations:
  # Step 1: Start with a transformation that uses SSF_CF as the initial source
  - add_variables:
      left_source: SSF_CF  # This establishes SSF_CF as the initial source
      column_mapping:
        temp_marker: "1"  # Add a temporary marker column

  # Step 2: Use union to combine SSF_CF and SSF_DUMMY_FACILITY
  - union:
      alias: UNIFIED_DATA
      column_mapping:
        SSF_CF:  # First source is the transformed SSF_CF with temp_marker
          DeliveryEntity: DeliveryEntity
          LocalFacilityIdentifier: LocalFacilityIdentifier
          ParentCreditFacility: ParentCreditFacility
        SSF_DUMMY_FACILITY:  # Second source
          DeliveryEntity: DeliveryEntity
          LocalFacilityIdentifier: LocalFacilityIdentifier
          ParentCreditFacility: ParentCreditFacility
  
  # Step 3: Join with FACILITY_ROLLUP
  - join:
      left_source: UNIFIED_DATA
      right_source: SSF_FACILITY_ROLLUP
      condition:
        - UNIFIED_DATA.LocalFacilityIdentifier = SSF_FACILITY_ROLLUP.LocalFacilityIdentifier
        - UNIFIED_DATA.DeliveryEntity = SSF_FACILITY_ROLLUP.DeliveryEntity
      how: left
  
  # Step 4: Filter for SubFacilityFlag = 0
  - filter:
      conditions:
        - SSF_FACILITY_ROLLUP.SubFacilityFlag = 0 OR SSF_FACILITY_ROLLUP.SubFacilityFlag IS NULL

expressions:
  # Core columns from UNIFIED_DATA (union of CF and DUMMY_FACILITY)
  DeliveryEntity: UNIFIED_DATA.DeliveryEntity
  LocalFacilityIdentifier: UNIFIED_DATA.LocalFacilityIdentifier
  ParentCreditFacility: UNIFIED_DATA.ParentCreditFacility
  
  # Facility rollup columns
  HighestExistingFacility: SSF_FACILITY_ROLLUP.HighestExistingFacility
  HighestFacilityExplained: SSF_FACILITY_ROLLUP.HighestFacilityExplained
  SubFacilityFlag: SSF_FACILITY_ROLLUP.SubFacilityFlag

drop_duplicates: true

filter_target:
- DeliveryEntity = '{{ DELIVERY_ENTITY }}'
