target: int_{{ RUN_MONTH }}.{{ DELIVERY_ENTITY }}_integrated_facility

sources:
  - alias: SSF_CF
    columns:
    - DeliveryEntity
    - LocalFacilityIdentifier
    - ParentCreditFacility
    source: stg_{{ RUN_MONTH }}.ssf_{{ DELIVERY_ENTITY }}_cf
  - alias: SSF_DUMMY_FACILITY
    columns:
    - DeliveryEntity
    - LocalFacilityIdentifier
    - ParentCreditFacility
    source: int_{{ RUN_MONTH }}.{{ DELIVERY_ENTITY }}_dummy_facility
  - alias: SSF_FACILITY_ROLLUP
    columns:
    - DeliveryEntity
    - LocalFacilityIdentifier
    - HighestExistingFacility
    - HighestFacilityExplained
    - SubFacilityFlag
    source: int_{{ RUN_MONTH }}.{{ DELIVERY_ENTITY }}_facility_rollup

# Add the initial_source parameter to specify the starting point
initial_source: SSF_CF

transformations:
  # Step 1: Union CF and DUMMY_FACILITY to get the base data
  - union:
      alias: UNIFIED_DATA
      column_mapping:
        SSF_CF:
          DeliveryEntity: DeliveryEntity
          LocalFacilityIdentifier: LocalFacilityIdentifier
          ParentCreditFacility: ParentCreditFacility
        SSF_DUMMY_FACILITY:
          DeliveryEntity: DeliveryEntity
          LocalFacilityIdentifier: LocalFacilityIdentifier
          ParentCreditFacility: ParentCreditFacility
  
  # Step 2: Join with FACILITY_ROLLUP to get HighestExistingFacility and HighestFacilityExplained
  - join:
      left_source: UNIFIED_DATA
      right_source: SSF_FACILITY_ROLLUP
      condition:
        - UNIFIED_DATA.LocalFacilityIdentifier = SSF_FACILITY_ROLLUP.LocalFacilityIdentifier
        - UNIFIED_DATA.DeliveryEntity = SSF_FACILITY_ROLLUP.DeliveryEntity
      how: left
      alias: FINAL_DATA
  
  # Step 3: Filter for SubFacilityFlag = 0
  - filter:
      source: FINAL_DATA
      conditions:
        - FINAL_DATA.SSF_FACILITY_ROLLUP.SubFacilityFlag = 0 OR FINAL_DATA.SSF_FACILITY_ROLLUP.SubFacilityFlag IS NULL

expressions:
  # Core columns from UNIFIED_DATA (union of CF and DUMMY_FACILITY)
  DeliveryEntity: FINAL_DATA.UNIFIED_DATA.DeliveryEntity
  LocalFacilityIdentifier: FINAL_DATA.UNIFIED_DATA.LocalFacilityIdentifier
  ParentCreditFacility: FINAL_DATA.UNIFIED_DATA.ParentCreditFacility
  
  # Facility rollup columns
  HighestExistingFacility: FINAL_DATA.SSF_FACILITY_ROLLUP.HighestExistingFacility
  HighestFacilityExplained: FINAL_DATA.SSF_FACILITY_ROLLUP.HighestFacilityExplained
  SubFacilityFlag: FINAL_DATA.SSF_FACILITY_ROLLUP.SubFacilityFlag

drop_duplicates: true

filter_target:
- DeliveryEntity = '{{ DELIVERY_ENTITY }}'
