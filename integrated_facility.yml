target: int_{{ RUN_MONTH }}.default_determination_{{ DELIVERY_ENTITY }}

sources:
  - alias: SSF_CF
    columns:
    - DeliveryEntity
    - LocalFacilityIdentifier
    - Default
    - DefaultDate
    - DefaultEndDate
    - NonperformingEndDate
    - NonperformingStartDate
    - PerformingIndicator
    - ReportingDate
    - AccruedFeesAmountDebitCreditIndicator
    - AccruedFeesAmountReportingAmount
    - AccruedFeesAmountReportingCurrency
    - AccruedFeesAmountTransactionAmount
    - AccruedFeesAmountTransactionCurrency
    - AlternativeLocalReferenceIdentifier
    - ApprovedLossGivenDefaultRatingDate
    - ArrangementParticipationType
    - BaselIIProductType
    - BookType
    - BorrowingBaseReportingAmount
    - BorrowingBaseReportingCurrency
    - BorrowingBaseTransactionAmount
    - BorrowingBaseTransactionCurrency
    - BusinessSegment
    - ContractStatus
    - ContractStatusDate
    - CreditAgreement
    - CreditAssessmentForDrawDownUnderUnadvisedCreditLimitIndicator
    - CreditConversionFactor
    - CreditLimitReportingAmount
    - CreditLimitReportingCurrency
    - CreditLimitTransactionAmount
    - CreditLimitTransactionCurrency
    - CreditProductProgramSegment
    - DownturnLossGivenDefault
    - EADAmountBeforeApplicationOfConservatismReportingAmount
    - EADAmountBeforeApplicationOfConservatismReportingCurrency
    - EADAmountBeforeApplicationOfConservatismTransactionAmount
    - EADAmountBeforeApplicationOfConservatismTransactionCurrency
    - EADModelCode
    - ELBEPercentageBeforeApplicationOfConservatism
    - ExemptionFromAdvancedInternalRatingBasedApproach
    - ExposureAtDefaultReportingAmount
    - ExposureAtDefaultReportingCurrency
    - FacilityType
    - Forborne
    - ForborneDate
    - GlobalFacilityIdentifier
    - HighQualityIndicator
    - Ifrs9RiskStage
    - IncomeProducingRealEstateFinance
    - InfrastructuralSupportingFactor
    - InsuredFlag
    - LandAcquisitionDevelopmentAndConstructionExposureFinance
    - LGDMarginOfConservatism
    - LGDModelCode
    - LGDPercentageBeforeConservatism
    - LGDType
    - LoanLossAllowanceRcoa
    - LoanLossAllowanceReportingAmount
    - LoanLossAllowanceReportingCurrency
    - LoanLossAllowanceTransactionAmount
    - LoanLossAllowanceTransactionCurrency
    - LocalReferenceIdentifier
    - LossGivenDefaultClass
    - MaturityDate
    - ParentCreditFacility
    - ParentCreditFacilitySourceSystemIdentifier
    - PDMarginOfConservatism
    - PDModelCode
    - PDPercentageBeforeConservatism
    - PensionerFlag
    - PlNplIndicator
    - ProbabilityOfDefault
    - ProductProgram
    - ProjectFinancePhaseIndicator
    - ReportingEntity
    - Revolving
    - RiskWeightedExposureApproach
    - SourceSystemIdentifier
    - SpecialisedLendingType
    - ThroughTheCycleLossGivenDefault
    - TradeDate
    - TypeOfCommitment
    - UnadvisedCreditLimitReportingAmount
    - UnadvisedCreditLimitReportingCurrency
    - UnadvisedCreditLimitTransactionAmount
    - UnadvisedCreditLimitTransactionCurrency
    - UndrawnRcoa
    - UndrawnReportingAmount
    - UndrawnReportingCurrency
    - UndrawnTransactionAmount
    - UndrawnTransactionCurrency
    source: stg_{{ RUN_MONTH }}.ssf_{{ DELIVERY_ENTITY }}_cf
  - alias: SSF_FACILITY_ROLLUP
    columns:
    - DeliveryEntity
    - LocalFacilityIdentifier
    - ParentCreditFacility
    - HighestExistingFacility
    source: int_{{ RUN_MONTH }}.ssf_facility_rollup_{{ DELIVERY_ENTITY }}
  - alias: SSF_DUMMY_FACILITY
    source: int_{{ RUN_MONTH }}.{{ DELIVERY_ENTITY }}_dummy_facility

transformations:
  - aggregation:
      group: [DeliveryEntity, HighestExistingFacility]
      column_mapping:
        HighestExistingFacility: "first(HighestExistingFacility)"
      source: SSF_FACILITY_ROLLUP
      alias: DISTINCT_HIGHEST_FACILITIES
  - join:
      left_source: SSF_CF
      right_source: DISTINCT_HIGHEST_FACILITIES
      condition:
      - SSF_CF.LocalFacilityIdentifier = DISTINCT_HIGHEST_FACILITIES.HighestExistingFacility
      how: inner
      alias: CF_WITH_HIGHEST_FACILITIES
  - union:
      alias: FINAL_UNION
      column_mapping:
        CF_WITH_HIGHEST_FACILITIES:
          DeliveryEntity: DeliveryEntity
          LocalFacilityIdentifier: LocalFacilityIdentifier
          Default: Default
          DefaultDate: DefaultDate
          DefaultEndDate: DefaultEndDate
          NonperformingEndDate: NonperformingEndDate
          NonperformingStartDate: NonperformingStartDate
          PerformingIndicator: PerformingIndicator
          ReportingDate: ReportingDate
          AccruedFeesAmountDebitCreditIndicator: AccruedFeesAmountDebitCreditIndicator
          AccruedFeesAmountReportingAmount: AccruedFeesAmountReportingAmount
          AccruedFeesAmountReportingCurrency: AccruedFeesAmountReportingCurrency
          AccruedFeesAmountTransactionAmount: AccruedFeesAmountTransactionAmount
          AccruedFeesAmountTransactionCurrency: AccruedFeesAmountTransactionCurrency
          AlternativeLocalReferenceIdentifier: AlternativeLocalReferenceIdentifier
          ApprovedLossGivenDefaultRatingDate: ApprovedLossGivenDefaultRatingDate
          ArrangementParticipationType: ArrangementParticipationType
          BaselIIProductType: BaselIIProductType
          BookType: BookType
          BorrowingBaseReportingAmount: BorrowingBaseReportingAmount
          BorrowingBaseReportingCurrency: BorrowingBaseReportingCurrency
          BorrowingBaseTransactionAmount: BorrowingBaseTransactionAmount
          BorrowingBaseTransactionCurrency: BorrowingBaseTransactionCurrency
          BusinessSegment: BusinessSegment
          ContractStatus: ContractStatus
          ContractStatusDate: ContractStatusDate
          CreditAgreement: CreditAgreement
          CreditAssessmentForDrawDownUnderUnadvisedCreditLimitIndicator: CreditAssessmentForDrawDownUnderUnadvisedCreditLimitIndicator
          CreditConversionFactor: CreditConversionFactor
          CreditLimitReportingAmount: CreditLimitReportingAmount
          CreditLimitReportingCurrency: CreditLimitReportingCurrency
          CreditLimitTransactionAmount: CreditLimitTransactionAmount
          CreditLimitTransactionCurrency: CreditLimitTransactionCurrency
          CreditProductProgramSegment: CreditProductProgramSegment
          DownturnLossGivenDefault: DownturnLossGivenDefault
          EADAmountBeforeApplicationOfConservatismReportingAmount: EADAmountBeforeApplicationOfConservatismReportingAmount
          EADAmountBeforeApplicationOfConservatismReportingCurrency: EADAmountBeforeApplicationOfConservatismReportingCurrency
          EADAmountBeforeApplicationOfConservatismTransactionAmount: EADAmountBeforeApplicationOfConservatismTransactionAmount
          EADAmountBeforeApplicationOfConservatismTransactionCurrency: EADAmountBeforeApplicationOfConservatismTransactionCurrency
          EADModelCode: EADModelCode
          ELBEPercentageBeforeApplicationOfConservatism: ELBEPercentageBeforeApplicationOfConservatism
          ExemptionFromAdvancedInternalRatingBasedApproach: ExemptionFromAdvancedInternalRatingBasedApproach
          ExposureAtDefaultReportingAmount: ExposureAtDefaultReportingAmount
          ExposureAtDefaultReportingCurrency: ExposureAtDefaultReportingCurrency
          FacilityType: FacilityType
          Forborne: Forborne
          ForborneDate: ForborneDate
          GlobalFacilityIdentifier: GlobalFacilityIdentifier
          HighQualityIndicator: HighQualityIndicator
          Ifrs9RiskStage: Ifrs9RiskStage
          IncomeProducingRealEstateFinance: IncomeProducingRealEstateFinance
          InfrastructuralSupportingFactor: InfrastructuralSupportingFactor
          InsuredFlag: InsuredFlag
          LandAcquisitionDevelopmentAndConstructionExposureFinance: LandAcquisitionDevelopmentAndConstructionExposureFinance
          LGDMarginOfConservatism: LGDMarginOfConservatism
          LGDModelCode: LGDModelCode
          LGDPercentageBeforeConservatism: LGDPercentageBeforeConservatism
          LGDType: LGDType
          LoanLossAllowanceRcoa: LoanLossAllowanceRcoa
          LoanLossAllowanceReportingAmount: LoanLossAllowanceReportingAmount
          LoanLossAllowanceReportingCurrency: LoanLossAllowanceReportingCurrency
          LoanLossAllowanceTransactionAmount: LoanLossAllowanceTransactionAmount
          LoanLossAllowanceTransactionCurrency: LoanLossAllowanceTransactionCurrency
          LocalReferenceIdentifier: LocalReferenceIdentifier
          LossGivenDefaultClass: LossGivenDefaultClass
          MaturityDate: MaturityDate
          ParentCreditFacility: ParentCreditFacility
          ParentCreditFacilitySourceSystemIdentifier: ParentCreditFacilitySourceSystemIdentifier
          PDMarginOfConservatism: PDMarginOfConservatism
          PDModelCode: PDModelCode
          PDPercentageBeforeConservatism: PDPercentageBeforeConservatism
          PensionerFlag: PensionerFlag
          PlNplIndicator: PlNplIndicator
          ProbabilityOfDefault: ProbabilityOfDefault
          ProductProgram: ProductProgram
          ProjectFinancePhaseIndicator: ProjectFinancePhaseIndicator
          ReportingEntity: ReportingEntity
          Revolving: Revolving
          RiskWeightedExposureApproach: RiskWeightedExposureApproach
          SourceSystemIdentifier: SourceSystemIdentifier
          SpecialisedLendingType: SpecialisedLendingType
          ThroughTheCycleLossGivenDefault: ThroughTheCycleLossGivenDefault
          TradeDate: TradeDate
          TypeOfCommitment: TypeOfCommitment
          UnadvisedCreditLimitReportingAmount: UnadvisedCreditLimitReportingAmount
          UnadvisedCreditLimitReportingCurrency: UnadvisedCreditLimitReportingCurrency
          UnadvisedCreditLimitTransactionAmount: UnadvisedCreditLimitTransactionAmount
          UnadvisedCreditLimitTransactionCurrency: UnadvisedCreditLimitTransactionCurrency
          UndrawnRcoa: UndrawnRcoa
          UndrawnReportingAmount: UndrawnReportingAmount
          UndrawnReportingCurrency: UndrawnReportingCurrency
          UndrawnTransactionAmount: UndrawnTransactionAmount
          UndrawnTransactionCurrency: UndrawnTransactionCurrency
        SSF_DUMMY_FACILITY:
          DeliveryEntity: DeliveryEntity
          LocalFacilityIdentifier: LocalFacilityIdentifier
          Default: Default
          DefaultDate: DefaultDate
          DefaultEndDate: DefaultEndDate
          NonperformingEndDate: NonperformingEndDate
          NonperformingStartDate: NonperformingStartDate
          PerformingIndicator: PerformingIndicator
          ReportingDate: ReportingDate
          AccruedFeesAmountDebitCreditIndicator: AccruedFeesAmountDebitCreditIndicator
          AccruedFeesAmountReportingAmount: AccruedFeesAmountReportingAmount
          AccruedFeesAmountReportingCurrency: AccruedFeesAmountReportingCurrency
          AccruedFeesAmountTransactionAmount: AccruedFeesAmountTransactionAmount
          AccruedFeesAmountTransactionCurrency: AccruedFeesAmountTransactionCurrency
          AlternativeLocalReferenceIdentifier: AlternativeLocalReferenceIdentifier
          ApprovedLossGivenDefaultRatingDate: ApprovedLossGivenDefaultRatingDate
          ArrangementParticipationType: ArrangementParticipationType
          BaselIIProductType: BaselIIProductType
          BookType: BookType
          BorrowingBaseReportingAmount: BorrowingBaseReportingAmount
          BorrowingBaseReportingCurrency: BorrowingBaseReportingCurrency
          BorrowingBaseTransactionAmount: BorrowingBaseTransactionAmount
          BorrowingBaseTransactionCurrency: BorrowingBaseTransactionCurrency
          BusinessSegment: BusinessSegment
          ContractStatus: ContractStatus
          ContractStatusDate: ContractStatusDate
          CreditAgreement: CreditAgreement
          CreditAssessmentForDrawDownUnderUnadvisedCreditLimitIndicator: CreditAssessmentForDrawDownUnderUnadvisedCreditLimitIndicator
          CreditConversionFactor: CreditConversionFactor
          CreditLimitReportingAmount: CreditLimitReportingAmount
          CreditLimitReportingCurrency: CreditLimitReportingCurrency
          CreditLimitTransactionAmount: CreditLimitTransactionAmount
          CreditLimitTransactionCurrency: CreditLimitTransactionCurrency
          CreditProductProgramSegment: CreditProductProgramSegment
          DownturnLossGivenDefault: DownturnLossGivenDefault
          EADAmountBeforeApplicationOfConservatismReportingAmount: EADAmountBeforeApplicationOfConservatismReportingAmount
          EADAmountBeforeApplicationOfConservatismReportingCurrency: EADAmountBeforeApplicationOfConservatismReportingCurrency
          EADAmountBeforeApplicationOfConservatismTransactionAmount: EADAmountBeforeApplicationOfConservatismTransactionAmount
          EADAmountBeforeApplicationOfConservatismTransactionCurrency: EADAmountBeforeApplicationOfConservatismTransactionCurrency
          EADModelCode: EADModelCode
          ELBEPercentageBeforeApplicationOfConservatism: ELBEPercentageBeforeApplicationOfConservatism
          ExemptionFromAdvancedInternalRatingBasedApproach: ExemptionFromAdvancedInternalRatingBasedApproach
          ExposureAtDefaultReportingAmount: ExposureAtDefaultReportingAmount
          ExposureAtDefaultReportingCurrency: ExposureAtDefaultReportingCurrency
          FacilityType: FacilityType
          Forborne: Forborne
          ForborneDate: ForborneDate
          GlobalFacilityIdentifier: GlobalFacilityIdentifier
          HighQualityIndicator: HighQualityIndicator
          Ifrs9RiskStage: Ifrs9RiskStage
          IncomeProducingRealEstateFinance: IncomeProducingRealEstateFinance
          InfrastructuralSupportingFactor: InfrastructuralSupportingFactor
          InsuredFlag: InsuredFlag
          LandAcquisitionDevelopmentAndConstructionExposureFinance: LandAcquisitionDevelopmentAndConstructionExposureFinance
          LGDMarginOfConservatism: LGDMarginOfConservatism
          LGDModelCode: LGDModelCode
          LGDPercentageBeforeConservatism: LGDPercentageBeforeConservatism
          LGDType: LGDType
          LoanLossAllowanceRcoa: LoanLossAllowanceRcoa
          LoanLossAllowanceReportingAmount: LoanLossAllowanceReportingAmount
          LoanLossAllowanceReportingCurrency: LoanLossAllowanceReportingCurrency
          LoanLossAllowanceTransactionAmount: LoanLossAllowanceTransactionAmount
          LoanLossAllowanceTransactionCurrency: LoanLossAllowanceTransactionCurrency
          LocalReferenceIdentifier: LocalReferenceIdentifier
          LossGivenDefaultClass: LossGivenDefaultClass
          MaturityDate: MaturityDate
          ParentCreditFacility: ParentCreditFacility
          ParentCreditFacilitySourceSystemIdentifier: ParentCreditFacilitySourceSystemIdentifier
          PDMarginOfConservatism: PDMarginOfConservatism
          PDModelCode: PDModelCode
          PDPercentageBeforeConservatism: PDPercentageBeforeConservatism
          PensionerFlag: PensionerFlag
          PlNplIndicator: PlNplIndicator
          ProbabilityOfDefault: ProbabilityOfDefault
          ProductProgram: ProductProgram
          ProjectFinancePhaseIndicator: ProjectFinancePhaseIndicator
          ReportingEntity: ReportingEntity
          Revolving: Revolving
          RiskWeightedExposureApproach: RiskWeightedExposureApproach
          SourceSystemIdentifier: SourceSystemIdentifier
          SpecialisedLendingType: SpecialisedLendingType
          ThroughTheCycleLossGivenDefault: ThroughTheCycleLossGivenDefault
          TradeDate: TradeDate
          TypeOfCommitment: TypeOfCommitment
          UnadvisedCreditLimitReportingAmount: UnadvisedCreditLimitReportingAmount
          UnadvisedCreditLimitReportingCurrency: UnadvisedCreditLimitReportingCurrency
          UnadvisedCreditLimitTransactionAmount: UnadvisedCreditLimitTransactionAmount
          UnadvisedCreditLimitTransactionCurrency: UnadvisedCreditLimitTransactionCurrency
          UndrawnRcoa: UndrawnRcoa
          UndrawnReportingAmount: UndrawnReportingAmount
          UndrawnReportingCurrency: UndrawnReportingCurrency
          UndrawnTransactionAmount: UndrawnTransactionAmount
          UndrawnTransactionCurrency: UndrawnTransactionCurrency

expressions:
  DeliveryEntity: DeliveryEntity
  LocalFacilityIdentifier: LocalFacilityIdentifier
  Default: Default
  DefaultDate: DefaultDate
  DefaultEndDate: DefaultEndDate
  NonperformingEndDate: NonperformingEndDate
  NonperformingStartDate: NonperformingStartDate
  PerformingIndicator: PerformingIndicator
  ReportingDate: ReportingDate
  AccruedFeesAmountDebitCreditIndicator: AccruedFeesAmountDebitCreditIndicator
  AccruedFeesAmountReportingAmount: AccruedFeesAmountReportingAmount
  AccruedFeesAmountReportingCurrency: AccruedFeesAmountReportingCurrency
  AccruedFeesAmountTransactionAmount: AccruedFeesAmountTransactionAmount
  AccruedFeesAmountTransactionCurrency: AccruedFeesAmountTransactionCurrency
  AlternativeLocalReferenceIdentifier: AlternativeLocalReferenceIdentifier
  ApprovedLossGivenDefaultRatingDate: ApprovedLossGivenDefaultRatingDate
  ArrangementParticipationType: ArrangementParticipationType
  BaselIIProductType: BaselIIProductType
  BookType: BookType
  BorrowingBaseReportingAmount: BorrowingBaseReportingAmount
  BorrowingBaseReportingCurrency: BorrowingBaseReportingCurrency
  BorrowingBaseTransactionAmount: BorrowingBaseTransactionAmount
  BorrowingBaseTransactionCurrency: BorrowingBaseTransactionCurrency
  BusinessSegment: BusinessSegment
  ContractStatus: ContractStatus
  ContractStatusDate: ContractStatusDate
  CreditAgreement: CreditAgreement
  CreditAssessmentForDrawDownUnderUnadvisedCreditLimitIndicator: CreditAssessmentForDrawDownUnderUnadvisedCreditLimitIndicator
  CreditConversionFactor: CreditConversionFactor
  CreditLimitReportingAmount: CreditLimitReportingAmount
  CreditLimitReportingCurrency: CreditLimitReportingCurrency
  CreditLimitTransactionAmount: CreditLimitTransactionAmount
  CreditLimitTransactionCurrency: CreditLimitTransactionCurrency
  CreditProductProgramSegment: CreditProductProgramSegment
  DownturnLossGivenDefault: DownturnLossGivenDefault
  EADAmountBeforeApplicationOfConservatismReportingAmount: EADAmountBeforeApplicationOfConservatismReportingAmount
  EADAmountBeforeApplicationOfConservatismReportingCurrency: EADAmountBeforeApplicationOfConservatismReportingCurrency
  EADAmountBeforeApplicationOfConservatismTransactionAmount: EADAmountBeforeApplicationOfConservatismTransactionAmount
  EADAmountBeforeApplicationOfConservatismTransactionCurrency: EADAmountBeforeApplicationOfConservatismTransactionCurrency
  EADModelCode: EADModelCode
  ELBEPercentageBeforeApplicationOfConservatism: ELBEPercentageBeforeApplicationOfConservatism
  ExemptionFromAdvancedInternalRatingBasedApproach: ExemptionFromAdvancedInternalRatingBasedApproach
  ExposureAtDefaultReportingAmount: ExposureAtDefaultReportingAmount
  ExposureAtDefaultReportingCurrency: ExposureAtDefaultReportingCurrency
  FacilityType: FacilityType
  Forborne: Forborne
  ForborneDate: ForborneDate
  GlobalFacilityIdentifier: GlobalFacilityIdentifier
  HighQualityIndicator: HighQualityIndicator
  Ifrs9RiskStage: Ifrs9RiskStage
  IncomeProducingRealEstateFinance: IncomeProducingRealEstateFinance
  InfrastructuralSupportingFactor: InfrastructuralSupportingFactor
  InsuredFlag: InsuredFlag
  LandAcquisitionDevelopmentAndConstructionExposureFinance: LandAcquisitionDevelopmentAndConstructionExposureFinance
  LGDMarginOfConservatism: LGDMarginOfConservatism
  LGDModelCode: LGDModelCode
  LGDPercentageBeforeConservatism: LGDPercentageBeforeConservatism
  LGDType: LGDType
  LoanLossAllowanceRcoa: LoanLossAllowanceRcoa
  LoanLossAllowanceReportingAmount: LoanLossAllowanceReportingAmount
  LoanLossAllowanceReportingCurrency: LoanLossAllowanceReportingCurrency
  LoanLossAllowanceTransactionAmount: LoanLossAllowanceTransactionAmount
  LoanLossAllowanceTransactionCurrency: LoanLossAllowanceTransactionCurrency
  LocalReferenceIdentifier: LocalReferenceIdentifier
  LossGivenDefaultClass: LossGivenDefaultClass
  MaturityDate: MaturityDate
  ParentCreditFacility: ParentCreditFacility
  ParentCreditFacilitySourceSystemIdentifier: ParentCreditFacilitySourceSystemIdentifier
  PDMarginOfConservatism: PDMarginOfConservatism
  PDModelCode: PDModelCode
  PDPercentageBeforeConservatism: PDPercentageBeforeConservatism
  PensionerFlag: PensionerFlag
  PlNplIndicator: PlNplIndicator
  ProbabilityOfDefault: ProbabilityOfDefault
  ProductProgram: ProductProgram
  ProjectFinancePhaseIndicator: ProjectFinancePhaseIndicator
  ReportingEntity: ReportingEntity
  Revolving: Revolving
  RiskWeightedExposureApproach: RiskWeightedExposureApproach
  SourceSystemIdentifier: SourceSystemIdentifier
  SpecialisedLendingType: SpecialisedLendingType
  ThroughTheCycleLossGivenDefault: ThroughTheCycleLossGivenDefault
  TradeDate: TradeDate
  TypeOfCommitment: TypeOfCommitment
  UnadvisedCreditLimitReportingAmount: UnadvisedCreditLimitReportingAmount
  UnadvisedCreditLimitReportingCurrency: UnadvisedCreditLimitReportingCurrency
  UnadvisedCreditLimitTransactionAmount: UnadvisedCreditLimitTransactionAmount
  UnadvisedCreditLimitTransactionCurrency: UnadvisedCreditLimitTransactionCurrency
  UndrawnRcoa: UndrawnRcoa
  UndrawnReportingAmount: UndrawnReportingAmount
  UndrawnReportingCurrency: UndrawnReportingCurrency
  UndrawnTransactionAmount: UndrawnTransactionAmount
  UndrawnTransactionCurrency: UndrawnTransactionCurrency

drop_duplicates: true

filter_target:
- DeliveryEntity = '{{ DELIVERY_ENTITY }}'
