description: The exemption claim is used to identify the regulatory approach that applies to an exposure. There are "exemptions" that are prescribed by the regulation in the CRR Article 150, however, institutions can also ask permission to move specific portfolios to less sophisticated approaches (both SA and FIRB). The reference table 1286 contains a set of exemption conditions which rely on different sourced attributes that are used to define the portfolios eligible for the application of both i) the prescribed regulatory PPUs portfolios and ii) the additional requested portfolios. This exemption claim will first be checked at Counterparty level and then at facility level and product level. This YAML is to determine exemption at credit facility level for RC.

target: enrich_{{ RUN_MONTH }}.{{ DELIVERY_ENTITY }}_exemptionclaim_creditfacility_rc

sources:
  # Main facility data source - already includes CounterpartyID and CounterpartySourceSystemIdentifier
  - alias: CF
    columns:
    - DeliveryEntity
    - ReportingDate
    - ReportingEntity
    - LocalFacilityIdentifier
    - SourceSystemIdentifier
    - CounterpartyID
    - CounterpartySourceSystemIdentifier
    - BaselIIProductType
    - PlNplIndicator
    - ProductProgram
    - SpecialisedLendingType
    - ExemptionFromAdvancedInternalRatingBasedApproach
    - SubFacilityFlag
    filter: SubFacilityFlag = 'N'
    source: int_{{ RUN_MONTH }}.{{ DELIVERY_ENTITY }}_integrated_creditfacility

  # Credit facility links for counterparty hierarchy
  - alias: INT_CF_LINKS
    source: int_{{ RUN_MONTH }}.{{ DELIVERY_ENTITY }}_integrated_creditfacility_links

  # SSF Counterparty data for Basel calculations
  - alias: INT_CP
    columns:
    - DeliveryEntity
    - ReportingDate
    - LocalId
    - SourceSystemIdentifier
    - GlobalCounterpartyIdentifier
    - BaselIICounterpartyType
    - ExemptionFromAdvancedInternalRatingBasedApproach
    source: int_{{ RUN_MONTH }}.{{ DELIVERY_ENTITY }}_integrated_counterparty

  # Exemption mapping table (1286) for RC
  - alias: 1286EXMP
    source: stg_{{ RUN_MONTH }}.bsl_andes_1286_b2_exmp_cond #TODO: confirm RC table name

  # PD UCR integration data
  - alias: PD_UCR
    columns:
    - CounterpartyID
    - CounterpartySourceSystemIdentifier
    - PDModelCode
    - LastPerformingPDModelCode
    source: int_{{ RUN_MONTH }}.{{ DELIVERY_ENTITY }}_pd_ucr_step3

  # Intercompany flag data
  - alias: IC
    columns:
    - CounterpartyID
    - CounterpartySourceSystemIdentifier
    - InterCompanyFlag
    source: int_{{ RUN_MONTH }}.{{ DELIVERY_ENTITY }}_intercompany

  # LGD model data
  - alias: LGD
    columns:
    - CreditFacilityID
    - CreditFacilitySourceSystemIdentifier
    - CounterpartyID
    - CounterpartySourceSystemIdentifier
    - LGDModelCode
    source: int_{{ RUN_MONTH }}.{{ DELIVERY_ENTITY }}_lgd

  # Counterparty level exemption claim RC
  - alias: EXMP_CP_RC
    source: enrich_{{ RUN_MONTH }}.{{ DELIVERY_ENTITY }}_exemptionclaim_counterparty_rc

transformations:
  # Join with INT_CP to get counterparty data
  - join:
      left_source: CF
      right_source: INT_CP
      condition:
        - CF.CounterpartyID = INT_CP.LocalId
        - CF.CounterpartySourceSystemIdentifier = INT_CP.SourceSystemIdentifier
      how: left
      alias: FAC_WITH_CP

  # Join with PD UCR data
  - join:
      left_source: FAC_WITH_CP
      right_source: PD_UCR
      condition:
        - FAC_WITH_CP.CounterpartyID = PD_UCR.CounterpartyID
        - FAC_WITH_CP.CounterpartySourceSystemIdentifier = PD_UCR.CounterpartySourceSystemIdentifier
      how: left
      alias: FAC_WITH_PD

  # Join with intercompany flag
  - join:
      left_source: FAC_WITH_PD
      right_source: IC
      condition:
        - FAC_WITH_PD.CounterpartyID = IC.CounterpartyID
        - FAC_WITH_PD.CounterpartySourceSystemIdentifier = IC.CounterpartySourceSystemIdentifier
      how: left
      alias: FAC_WITH_IC

  # Join with LGD data
  - join:
      left_source: FAC_WITH_IC
      right_source: LGD
      condition:
        - FAC_WITH_IC.LocalFacilityIdentifier = LGD.CreditFacilityID
        - FAC_WITH_IC.SourceSystemIdentifier = LGD.CreditFacilitySourceSystemIdentifier
      how: left
      alias: FAC_WITH_LGD

  # Join with exemption mapping table RC for facility level
  - join:
      left_source: FAC_WITH_LGD
      right_source: 1286EXMP
      condition:
        - 1286EXMP.reporting_entity_id = FAC_WITH_LGD.ReportingEntity or 1286EXMP.reporting_entity_id = '*'
        - 1286EXMP.b2_pd_type_id = FAC_WITH_LGD.BaselIIProductType or 1286EXMP.b2_pd_type_id = '*'
        - 1286EXMP.lgd_rtg_model = FAC_WITH_LGD.LGDModelCode or 1286EXMP.lgd_rtg_model = '*'
        - 1286EXMP.pl_npl_indicator = FAC_WITH_LGD.PlNplIndicator or 1286EXMP.pl_npl_indicator = '*'
        - 1286EXMP.specialised_lending_type = FAC_WITH_LGD.SpecialisedLendingType or 1286EXMP.specialised_lending_type = '*'
        - 1286EXMP.cr_pd_program = FAC_WITH_LGD.ProductProgram or 1286EXMP.cr_pd_program = '*'
        - 1286EXMP.pd_rtg_model = FAC_WITH_LGD.PDModelCode or 1286EXMP.pd_rtg_model = FAC_WITH_LGD.LastPerformingPDModelCode or 1286EXMP.pd_rtg_model = '*'
        - 1286EXMP.b2_cpty_type_id = FAC_WITH_LGD.BaselIICounterpartyType or 1286EXMP.b2_cpty_type_id = '*'
        - 1286EXMP.intercompany_flag = FAC_WITH_LGD.InterCompanyFlag = 'Y' or 1286EXMP.intercompany_flag = '*'
        - upper(1286EXMP.sourced_exemption_id) = upper(coalesce(FAC_WITH_LGD.ExemptionFromAdvancedInternalRatingBasedApproach, FAC_WITH_LGD.ExemptionFromAdvancedInternalRatingBasedApproach)) or 1286EXMP.sourced_exemption_id = '*'
        - (1286EXMP.ctpty_ssc || 1286EXMP.ctpty_uid = FAC_WITH_LGD.LocalId) OR
          (1286EXMP.ctpty_ssc = 'EPR' and ltrim('0', 1286EXMP.ctpty_uid) = ltrim('0', FAC_WITH_LGD.GlobalCounterpartyIdentifier)) OR  
          (1286EXMP.ctpty_uid = '*')
      how: left
      alias: FAC_WITH_EXMP
  
  - add_variables:
      source: FAC_WITH_EXMP
      column_mapping:
        var_lowest_ExemptionClaimConditonID_FAC_RC: min(FAC_WITH_EXMP.exemption_condition_id) OVER (PARTITION BY FAC_WITH_EXMP.LocalFacilityIdentifier)

  # To get Lowest Exemption Condition ID on Counterparty level RC
  - join:
      right_source: INT_CF_LINKS
      condition:
        - FAC_WITH_EXMP.LocalFacilityIdentifier = INT_CF_LINKS.CreditFacility
        - FAC_WITH_EXMP.SourceSystemIdentifier = INT_CF_LINKS.CreditFacilitySourceSystemIdentifier
      how: left
      alias: FAC_WITH_LINKS
  
  - join:
      left_source: FAC_WITH_LINKS
      right_source: EXMP_CP_RC
      condition:
        - FAC_WITH_LINKS.ParticipatingCounterparty = EXMP_CP_RC.CounterpartyID
        - FAC_WITH_LINKS.ParticipatingCounterpartySourceSystemIdentifier = EXMP_CP_RC.CounterpartySourceSystemIdentifier
      how: left
      alias: FINAL_DATA
  
  - add_variables:
      source: FINAL_DATA
      column_mapping:
        var_lowest_ExemptionClaimConditonID_CP_RC: min(FINAL_DATA.ExemptionConditionIdRC) OVER (PARTITION BY FINAL_DATA.CreditFacility)

expressions:
  DeliveryEntity: FINAL_DATA.DeliveryEntity
  ReportingDate: FINAL_DATA.ReportingDate
  ReportingEntity: FINAL_DATA.ReportingEntity
  CreditFacilityID: FINAL_DATA.LocalFacilityIdentifier
  CreditFacilitySourceSystemIdentifier: FINAL_DATA.SourceSystemIdentifier
  CounterpartyID: FINAL_DATA.CounterpartyID
  CounterpartySourceSystemIdentifier: FINAL_DATA.CounterpartySourceSystemIdentifier
  BaselProductType: FINAL_DATA.BaselIIProductType
  PlNplIndicator: FINAL_DATA.PlNplIndicator
  SpecialisedLendingType: FINAL_DATA.SpecialisedLendingType
  SourcedExemptionId: FINAL_DATA.ExemptionFromAdvancedInternalRatingBasedApproach
  PDModelCode: FINAL_DATA.PDModelCode
  LastPerformingPDModelCode: FINAL_DATA.LastPerformingPDModelCode
  InterCompanyFlag: FINAL_DATA.InterCompanyFlag
  LGDModelCode: FINAL_DATA.LGDModelCode
  BaselCreditRiskApproach: coalesce( 
    case when least(FINAL_DATA.exemption_condition_id, var_lowest_ExemptionClaimConditonID_CP_RC) = var_lowest_ExemptionClaimConditonID_CP_RC 
         then FINAL_DATA.BaselCreditRiskApproach 
    end,
    case when FINAL_DATA.basel_approach='STD' then 'SA'
         when FINAL_DATA.basel_approach='FOU' then 'FIRB'
         when FINAL_DATA.basel_approach='IRB' then 'AIRB'
         else FINAL_DATA.basel_approach
    end
    )
  ExemptionConditionIdRC: least(FINAL_DATA.exemption_condition_id, var_lowest_ExemptionClaimConditonID_CP_RC)
  ExemptionIdRC: coalesce(
    case when least(FINAL_DATA.exemption_condition_id, var_lowest_ExemptionClaimConditonID_CP_RC) = var_lowest_ExemptionClaimConditonID_CP_RC 
         then FINAL_DATA.ExemptionIdRC 
    end,
    FINAL_DATA.exemption_id
    )
  ExemptionNameRC: coalesce(
    case when least(FINAL_DATA.exemption_condition_id, var_lowest_ExemptionClaimConditonID_CP_RC) = var_lowest_ExemptionClaimConditonID_CP_RC 
         then FINAL_DATA.ExemptionNameRC 
    end,
    FINAL_DATA.exemption_name
    )
  ExemptionTypeRC: coalesce(
    case when least(FINAL_DATA.exemption_condition_id, var_lowest_ExemptionClaimConditonID_CP_RC) = var_lowest_ExemptionClaimConditonID_CP_RC 
         then FINAL_DATA.ExemptionTypeRC 
    end,
    case when FINAL_DATA.exemption_end_date= '9999-12-31' then 'P' else 'T' end
    )

filter_target:
- FINAL_DATA.exemption_condition_id is not null or var_lowest_ExemptionClaimConditonID_CP_RC is not null
- ExemptionConditionIdRC = var_lowest_ExemptionClaimConditonID_FAC_RC or ExemptionConditionIdRC = var_lowest_ExemptionClaimConditonID_CP_RC

drop_duplicates: true
