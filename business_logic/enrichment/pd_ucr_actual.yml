target: int_{{ RUN_MONTH }}.pd_ucr_actual

sources:
  - alias: DIAL_FAIR_PD_UCR
    columns:
    - PD_RATING_ID
    - COMPANY_ID
    - RATING_STATUS
    - RATING_PROVIDING_SYSTEM
    - PD_MODEL_VERSION
    - STAND_ALONE_RATING_PD
    - STAND_ALONE_RATING_UCR
    - COUNTRY_RISK_ADJUSTED_PD
    - COUNTRY_RISK_ADJUSTED_UCR
    - GROUP_SUPPORT_ADJUSTED_PD
    - GROUP_SUPPORT_ADJUSTED_UCR
    - L1_OVERRIDE_PD
    - L1_OVERRIDE_UCR
    - PROPOSED_PD
    - PROPOSED_UCR
    - L2_OVERRIDE_PD
    - L2_OVERRIDE_UCR
    - APPROVED_PD
    - APPROVED_UCR
    - PD_APPROVAL_DATE
    - PD_EXPIRY_DATE
    - FAIR_ID
    - LBCDB_ID
    - GBCDB_ID
    - HREKNR
    - RAPID_ID
    - T24_ID
    - DUNS
    - GRACE_ID
    - CS_ID
    - COUNTRY_CODE
    - PORTFOLIO
    - BUSINESSLINE
    - RATING_ID
    - PARENT_COMPANY_ID
    - PARENT_RATING_REVIEW_ALERT
    - SOVEREIGN_RATING_REVIEW_ALERT
    - USED_FINANCIALS_EXPIRATION_ALERT
    - PD_INCLUDING_CONSERVATISM
    - UCR_INCLUDING_CONSERVATISM
    - TYPE_OF_CONSERVATISM
    - MARGIN_OF_CONSERVATISM
    - PD_FLOORED
    - PROPOSER
    - APPROVER
    - LB_RATING_ID
    source: stg_{{ RUN_MONTH }}.dial_fair_pd_ucr

  # Historical performing ratings (UCR not in 6,7,8) for best performing
  - alias: HIST_PERF_RATINGS 
    columns:
    - COMPANY_ID
    - PD_MODEL_VERSION
    - APPROVED_UCR
    - PD_APPROVAL_DATE
    - PORTFOLIO
    - BUSINESSLINE
    - RATING_ID
    source: stg_{{ RUN_MONTH }}.dial_fair_pd_ucr
    filter: APPROVED_UCR NOT IN ('6', '7', '8')

  # All historical ratings for fallback
  - alias: HIST_ALL_RATINGS
    columns:
    - COMPANY_ID
    - PD_MODEL_VERSION
    - RATING_ID
    - PORTFOLIO
    - BUSINESSLINE
    source: stg_{{ RUN_MONTH }}.dial_fair_pd_ucr

transformations:
  # Create variables for filtering
  - add_variables:
      source: DIAL_FAIR_PD_UCR
      column_mapping:
        var_months_since_approval: months_between(current_date(), DIAL_FAIR_PD_UCR.PD_APPROVAL_DATE)
  
  # Fallback Model Logic
  # Step 1: Find lowest rating_id for each company+portfolio+businessline
  - aggregation:
      alias: FALLBACK_LOOKUP
      source: HIST_ALL_RATINGS
      group:
      - HIST_ALL_RATINGS.COMPANY_ID
      - HIST_ALL_RATINGS.PORTFOLIO
      - HIST_ALL_RATINGS.BUSINESSLINE
      column_mapping:
        min_rating_id: min(HIST_ALL_RATINGS.RATING_ID)
  
  # Step 2: Join to get the model for the lowest rating_id
  - join:
      left_source: FALLBACK_LOOKUP
      right_source: HIST_ALL_RATINGS
      how: inner
      condition:
      - FALLBACK_LOOKUP.COMPANY_ID = HIST_ALL_RATINGS.COMPANY_ID
      - FALLBACK_LOOKUP.PORTFOLIO = HIST_ALL_RATINGS.PORTFOLIO
      - FALLBACK_LOOKUP.BUSINESSLINE = HIST_ALL_RATINGS.BUSINESSLINE
      - FALLBACK_LOOKUP.min_rating_id = HIST_ALL_RATINGS.RATING_ID
  
  # Step 3: Get the model for the record with lowest rating_id
  - aggregation:
      alias: FALLBACK_MODEL
      group:
      - FALLBACK_LOOKUP.COMPANY_ID
      - FALLBACK_LOOKUP.PORTFOLIO
      - FALLBACK_LOOKUP.BUSINESSLINE
      column_mapping:
        fallback_model: first(HIST_ALL_RATINGS.PD_MODEL_VERSION)
  
  # Best Performing Model Logic - SEPARATELY  
  # Step 1: Find most recent performing rating date
  - aggregation:
      alias: BEST_PERFORMING_DATE
      source: HIST_PERF_RATINGS
      group:
      - HIST_PERF_RATINGS.COMPANY_ID
      - HIST_PERF_RATINGS.PORTFOLIO
      - HIST_PERF_RATINGS.BUSINESSLINE
      column_mapping:
        most_recent_date: max(HIST_PERF_RATINGS.PD_APPROVAL_DATE)
  
  # Step 2: Join to get records with most recent date
  - join:
      left_source: BEST_PERFORMING_DATE
      right_source: HIST_PERF_RATINGS
      how: inner
      condition:
      - BEST_PERFORMING_DATE.COMPANY_ID = HIST_PERF_RATINGS.COMPANY_ID
      - BEST_PERFORMING_DATE.PORTFOLIO = HIST_PERF_RATINGS.PORTFOLIO
      - BEST_PERFORMING_DATE.BUSINESSLINE = HIST_PERF_RATINGS.BUSINESSLINE
      - BEST_PERFORMING_DATE.most_recent_date = HIST_PERF_RATINGS.PD_APPROVAL_DATE
  
  # Step 3: Find highest rating_id among most recent records
  - aggregation:
      alias: BEST_PERFORMING_ID
      group:
      - BEST_PERFORMING_DATE.COMPANY_ID
      - BEST_PERFORMING_DATE.PORTFOLIO
      - BEST_PERFORMING_DATE.BUSINESSLINE
      column_mapping:
        max_rating_id: max(HIST_PERF_RATINGS.RATING_ID)
  
  # Step 4: Join to get the record with highest rating_id
  - join:
      left_source: BEST_PERFORMING_ID
      right_source: HIST_PERF_RATINGS
      how: inner
      condition:
      - BEST_PERFORMING_ID.COMPANY_ID = HIST_PERF_RATINGS.COMPANY_ID
      - BEST_PERFORMING_ID.PORTFOLIO = HIST_PERF_RATINGS.PORTFOLIO
      - BEST_PERFORMING_ID.BUSINESSLINE = HIST_PERF_RATINGS.BUSINESSLINE
      - BEST_PERFORMING_ID.max_rating_id = HIST_PERF_RATINGS.RATING_ID
  
  # Step 5: Get the model for the record with highest rating_id
  - aggregation:
      alias: BEST_PERFORMING_MODEL
      group:
      - BEST_PERFORMING_ID.COMPANY_ID
      - BEST_PERFORMING_ID.PORTFOLIO
      - BEST_PERFORMING_ID.BUSINESSLINE
      column_mapping:
        best_performing_model: first(HIST_PERF_RATINGS.PD_MODEL_VERSION)
  
  # Now join both results to main data
  # Step 1: Join best performing model
  - join:
      left_source: DIAL_FAIR_PD_UCR
      right_source: BEST_PERFORMING_MODEL
      how: left
      condition:
      - DIAL_FAIR_PD_UCR.COMPANY_ID = BEST_PERFORMING_MODEL.COMPANY_ID
      - DIAL_FAIR_PD_UCR.PORTFOLIO = BEST_PERFORMING_MODEL.PORTFOLIO
      - DIAL_FAIR_PD_UCR.BUSINESSLINE = BEST_PERFORMING_MODEL.BUSINESSLINE
  
  # Step 2: Join fallback model
  - join:
      right_source: FALLBACK_MODEL
      how: left
      condition:
      - DIAL_FAIR_PD_UCR.COMPANY_ID = FALLBACK_MODEL.COMPANY_ID
      - DIAL_FAIR_PD_UCR.PORTFOLIO = FALLBACK_MODEL.PORTFOLIO
      - DIAL_FAIR_PD_UCR.BUSINESSLINE = FALLBACK_MODEL.BUSINESSLINE

expressions:
  PD_RATING_ID: DIAL_FAIR_PD_UCR.PD_RATING_ID
  COMPANY_ID: DIAL_FAIR_PD_UCR.COMPANY_ID
  RATING_STATUS: DIAL_FAIR_PD_UCR.RATING_STATUS
  RATING_PROVIDING_SYSTEM: DIAL_FAIR_PD_UCR.RATING_PROVIDING_SYSTEM
  PD_MODEL_VERSION: DIAL_FAIR_PD_UCR.PD_MODEL_VERSION
  STAND_ALONE_RATING_PD: DIAL_FAIR_PD_UCR.STAND_ALONE_RATING_PD
  STAND_ALONE_RATING_UCR: DIAL_FAIR_PD_UCR.STAND_ALONE_RATING_UCR
  COUNTRY_RISK_ADJUSTED_PD: DIAL_FAIR_PD_UCR.COUNTRY_RISK_ADJUSTED_PD
  COUNTRY_RISK_ADJUSTED_UCR: DIAL_FAIR_PD_UCR.COUNTRY_RISK_ADJUSTED_UCR
  GROUP_SUPPORT_ADJUSTED_PD: DIAL_FAIR_PD_UCR.GROUP_SUPPORT_ADJUSTED_PD
  GROUP_SUPPORT_ADJUSTED_UCR: DIAL_FAIR_PD_UCR.GROUP_SUPPORT_ADJUSTED_UCR
  L1_OVERRIDE_PD: DIAL_FAIR_PD_UCR.L1_OVERRIDE_PD
  L1_OVERRIDE_UCR: DIAL_FAIR_PD_UCR.L1_OVERRIDE_UCR
  PROPOSED_PD: DIAL_FAIR_PD_UCR.PROPOSED_PD
  PROPOSED_UCR: DIAL_FAIR_PD_UCR.PROPOSED_UCR
  L2_OVERRIDE_PD: DIAL_FAIR_PD_UCR.L2_OVERRIDE_PD
  L2_OVERRIDE_UCR: DIAL_FAIR_PD_UCR.L2_OVERRIDE_UCR
  APPROVED_PD: DIAL_FAIR_PD_UCR.APPROVED_PD
  APPROVED_UCR: DIAL_FAIR_PD_UCR.APPROVED_UCR
  PD_APPROVAL_DATE: DIAL_FAIR_PD_UCR.PD_APPROVAL_DATE
  PD_EXPIRY_DATE: DIAL_FAIR_PD_UCR.PD_EXPIRY_DATE
  FAIR_ID: DIAL_FAIR_PD_UCR.FAIR_ID
  LBCDB_ID: DIAL_FAIR_PD_UCR.LBCDB_ID
  GBCDB_ID: DIAL_FAIR_PD_UCR.GBCDB_ID
  HREKNR: DIAL_FAIR_PD_UCR.HREKNR
  RAPID_ID: DIAL_FAIR_PD_UCR.RAPID_ID
  T24_ID: DIAL_FAIR_PD_UCR.T24_ID
  DUNS: DIAL_FAIR_PD_UCR.DUNS
  GRACE_ID: DIAL_FAIR_PD_UCR.GRACE_ID
  CS_ID: DIAL_FAIR_PD_UCR.CS_ID
  COUNTRY_CODE: DIAL_FAIR_PD_UCR.COUNTRY_CODE
  PORTFOLIO: DIAL_FAIR_PD_UCR.PORTFOLIO
  BUSINESSLINE: DIAL_FAIR_PD_UCR.BUSINESSLINE
  RATING_ID: DIAL_FAIR_PD_UCR.RATING_ID
  PARENT_COMPANY_ID: DIAL_FAIR_PD_UCR.PARENT_COMPANY_ID
  PARENT_RATING_REVIEW_ALERT: DIAL_FAIR_PD_UCR.PARENT_RATING_REVIEW_ALERT
  SOVEREIGN_RATING_REVIEW_ALERT: DIAL_FAIR_PD_UCR.SOVEREIGN_RATING_REVIEW_ALERT
  USED_FINANCIALS_EXPIRATION_ALERT: DIAL_FAIR_PD_UCR.USED_FINANCIALS_EXPIRATION_ALERT
  PD_INCLUDING_CONSERVATISM: DIAL_FAIR_PD_UCR.PD_INCLUDING_CONSERVATISM
  UCR_INCLUDING_CONSERVATISM: DIAL_FAIR_PD_UCR.UCR_INCLUDING_CONSERVATISM
  TYPE_OF_CONSERVATISM: DIAL_FAIR_PD_UCR.TYPE_OF_CONSERVATISM
  MARGIN_OF_CONSERVATISM: DIAL_FAIR_PD_UCR.MARGIN_OF_CONSERVATISM
  PD_FLOORED: DIAL_FAIR_PD_UCR.PD_FLOORED
  PROPOSER: DIAL_FAIR_PD_UCR.PROPOSER
  APPROVER: DIAL_FAIR_PD_UCR.APPROVER
  LB_RATING_ID: DIAL_FAIR_PD_UCR.LB_RATING_ID
  
  # LastPerformingModel logic - exactly as specified in the user story
  LastPerformingModel: >
    CASE 
      WHEN DIAL_FAIR_PD_UCR.APPROVED_UCR NOT IN ('6', '7', '8') THEN DIAL_FAIR_PD_UCR.PD_MODEL_VERSION 
      WHEN BEST_PERFORMING_MODEL.best_performing_model IS NOT NULL THEN BEST_PERFORMING_MODEL.best_performing_model 
      ELSE FALLBACK_MODEL.fallback_model 
    END

# Filter exactly as specified in user story: 24 months from current reporting date
filter_target:
  - DIAL_FAIR_PD_UCR.RATING_STATUS = 'ACTUAL' AND (months_between(current_date(), DIAL_FAIR_PD_UCR.PD_APPROVAL_DATE) < 24 OR DIAL_FAIR_PD_UCR.APPROVED_UCR IN ('6', '7', '8'))

drop_duplicates: true
