description: The exemption claim is used to identify the regulatory approach that applies to an exposure. This YAML is to determine exemption at counterparty level for RC.

target: enrich_{{ RUN_MONTH }}.{{ DELIVERY_ENTITY }}_exemptionclaim_counterparty_rc

sources:
  # SSF Counterparty data for Basel calculations
  - alias: INT_CP
    columns:
    - DeliveryEntity
    - ReportingDate
    - LocalId
    - SourceSystemIdentifier
    - GlobalCounterpartyIdentifier
    - BaselIICounterpartyType
    - ExemptionFromAdvancedInternalRatingBasedApproach
    source: int_{{ RUN_MONTH }}.{{ DELIVERY_ENTITY }}_integrated_counterparty

  # Exemption mapping table (1286) for RC
  - alias: EXMP_1286
    columns:
    - exemption_condition_id
    - exemption_id
    - exemption_name
    - exemption_end_date
    - basel_approach
    - reporting_entity_id
    - b2_pd_type_id
    - lgd_rtg_model
    - pl_npl_indicator
    - specialised_lending_type
    - cr_pd_program
    - pd_rtg_model
    - b2_cpty_type_id
    - intercompany_flag
    - sourced_exemption_id
    - ctpty_ssc
    - ctpty_uid
    source: stg_{{ RUN_MONTH }}.bsl_andes_1286_b2_exmp_cond

  # PD UCR integration data
  - alias: PD_UCR
    columns:
    - CounterpartyID
    - CounterpartySourceSystemIdentifier
    - PDModelCode
    - LastPerformingPDModelCode
    source: int_{{ RUN_MONTH }}.{{ DELIVERY_ENTITY }}_pd_ucr_step3

  # Intercompany flag data
  - alias: IC
    columns:
    - CounterpartyID
    - CounterpartySourceSystemIdentifier
    - InterCompanyFlag
    source: int_{{ RUN_MONTH }}.{{ DELIVERY_ENTITY }}_intercompany

transformations:
  # Join with PD UCR data
  - join:
      left_source: INT_CP
      right_source: PD_UCR
      condition:
        - INT_CP.LocalId = PD_UCR.CounterpartyID
        - INT_CP.SourceSystemIdentifier = PD_UCR.CounterpartySourceSystemIdentifier
      how: left

  # Join with intercompany flag
  - join:
      right_source: IC
      condition:
        - INT_CP.LocalId = IC.CounterpartyID
        - INT_CP.SourceSystemIdentifier = IC.CounterpartySourceSystemIdentifier
      how: left

  # Join with exemption mapping table RC
  - join:
      right_source: EXMP_1286
      condition:
        - EXMP_1286.reporting_entity_id = '*'
        - EXMP_1286.b2_pd_type_id = '*'
        - EXMP_1286.lgd_rtg_model = '*'
        - EXMP_1286.pl_npl_indicator = '*'
        - EXMP_1286.specialised_lending_type = '*'
        - EXMP_1286.cr_pd_program = '*'
        - EXMP_1286.pd_rtg_model = PD_UCR.PDModelCode or EXMP_1286.pd_rtg_model = PD_UCR.LastPerformingPDModelCode or EXMP_1286.pd_rtg_model = '*'
        - EXMP_1286.b2_cpty_type_id = INT_CP.BaselIICounterpartyType or EXMP_1286.b2_cpty_type_id = '*'
        - EXMP_1286.intercompany_flag = IC.InterCompanyFlag = 'Y' or EXMP_1286.intercompany_flag = '*'
        - upper(EXMP_1286.sourced_exemption_id) = upper(INT_CP.ExemptionFromAdvancedInternalRatingBasedApproach) or EXMP_1286.sourced_exemption_id = '*'
        - (EXMP_1286.ctpty_ssc || EXMP_1286.ctpty_uid = INT_CP.LocalId) OR
          (EXMP_1286.ctpty_ssc = 'EPR' and ltrim('0', EXMP_1286.ctpty_uid) = ltrim('0', INT_CP.GlobalCounterpartyIdentifier)) OR  
          (EXMP_1286.ctpty_uid = '*')
      how: left

  - add_variables:
      column_mapping:
        var_lowest_ExemptionClaimConditonID_RC: min(EXMP_1286.exemption_condition_id) OVER (PARTITION BY INT_CP.LocalId)

expressions:
  DeliveryEntity: INT_CP.DeliveryEntity
  ReportingDate: INT_CP.ReportingDate
  CounterpartyID: INT_CP.LocalId
  CounterpartySourceSystemIdentifier: INT_CP.SourceSystemIdentifier
  GlobalCounterpartyIdentifier: INT_CP.GlobalCounterpartyIdentifier
  SourcedExemptionId: INT_CP.ExemptionFromAdvancedInternalRatingBasedApproach
  PDModelCode: PD_UCR.PDModelCode
  LastPerformingPDModelCode: PD_UCR.LastPerformingPDModelCode
  IntercompanyFlag: IC.InterCompanyFlag
  BaselCreditRiskApproach: case when EXMP_1286.basel_approach='STD' then 'SA'
                                when EXMP_1286.basel_approach='FOU' then 'FIRB'
                                when EXMP_1286.basel_approach='IRB' then 'AIRB'
                                else EXMP_1286.basel_approach
                            end
  ExemptionConditionIdRC: EXMP_1286.exemption_condition_id
  ExemptionIdRC: EXMP_1286.exemption_id
  ExemptionNameRC: EXMP_1286.exemption_name
  ExemptionTypeRC: case when EXMP_1286.exemption_end_date = '9999-12-31' then 'P' else 'T' end

filter_target:
- EXMP_1286.exemption_condition_id is not null
- ExemptionConditionIdRC = var_lowest_ExemptionClaimConditonID_RC

drop_duplicates: true
