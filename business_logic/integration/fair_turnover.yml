description: Pipeline to preprocess FAIR data to get turnover and total asset values per rating ID

target: bsrc_d.int_{{ RUN_MONTH }}.fair_turnover

sources:
  - alias: UCR_ACTUAL
    columns:
      - COMPANY_ID
      - RATING_ID
      - RATING_STATUS
      - PARENT_COMPANY_ID
      - LB_RATING_ID
    source: int_{{ RUN_MONTH }}.pd_ucr_actual
  
  - alias: PD_ITERATIONS
    columns:
      - RATING_ID
      - RECOMMENDED
      - ITERATION_NUMBER
    filter: RECOMMENDED = 'y'
    source: stg_{{ RUN_MONTH }}.dial_fair_pd_iterations
  
  - alias: MODEL_ESSENTIALS
    columns:
      - RATING_ID
      - CALCULATION_PERIOD_ID
      - MODEL_COMPONENT_ESSENTIAL_TYPE_CODE
      - MODEL_COMPONENT_ESSENTIAL_VALUE
      - MODEL_COMPONENT_ESSENTIAL_CATEGORY_VARIANT_ID
      - ITERATION_NUMBER
    filter: MODEL_COMPONENT_ESSENTIAL_TYPE_CODE IN ('CorrectedTotalAssets', 'TotalBalanceSheet', 'Assets', 'TotalAssets', 'TotalTurnoverTurnover', 'Turnover', 'Budget', 'Revenues', 'TotalRevenues', 'TotalOperatingIncome') AND MODEL_COMPONENT_ESSENTIAL_CATEGORY_VARIANT_ID = 'cons'
    source: stg_{{ RUN_MONTH }}.dial_fair_pd_model_component_essentials
  
  - alias: LBR_QUANTITATIVE
    columns:
      - LB_RATING_ID
      - DATA_TYPE
      - TOTAL_ASSETS
      - NET_INTEREST_YIELD
      - OTHER_OPERATING_INCOME
    filter: DATA_TYPE = 2
    source: stg_{{ RUN_MONTH }}.dial_fair_lbr_quantitative_input

transformations:
  # Step 1: Join iterations with model essentials on ITERATION_NUMBER to select only recommended iterations
  - join:
      left_source: MODEL_ESSENTIALS
      right_source: PD_ITERATIONS
      condition:
        - MODEL_ESSENTIALS.RATING_ID = PD_ITERATIONS.RATING_ID
        - MODEL_ESSENTIALS.ITERATION_NUMBER = PD_ITERATIONS.ITERATION_NUMBER
      how: inner
  
  # Step 2: Join with UCR actual data
  - join:
      right_source: UCR_ACTUAL
      condition:
        - MODEL_ESSENTIALS.RATING_ID = UCR_ACTUAL.RATING_ID
      how: inner
  
  # Step 3: Pivot the MODEL_COMPONENT_ESSENTIAL_TYPE_CODE values to columns
  - pivot:
      alias: PIVOTED_ESSENTIALS
      group_cols:
        - UCR_ACTUAL.RATING_ID
        - UCR_ACTUAL.COMPANY_ID
        - UCR_ACTUAL.PARENT_COMPANY_ID
        - UCR_ACTUAL.LB_RATING_ID
      pivot_col: MODEL_ESSENTIALS.MODEL_COMPONENT_ESSENTIAL_TYPE_CODE
      pivot_value_col: MODEL_ESSENTIALS.MODEL_COMPONENT_ESSENTIAL_VALUE
      column_mapping:
        CorrectedTotalAssets: max
        TotalBalanceSheet: max
        Assets: max
        TotalAssets: max
        TotalTurnoverTurnover: max
        Turnover: max
        Budget: max
        Revenues: max
        TotalRevenues: max
        TotalOperatingIncome: max
  
  # Step 4: Create DIRECT data with calculated Total Assets and Turnover
  - aggregation:
      alias: DIRECT_DATA
      source: PIVOTED_ESSENTIALS
      group:
        - PIVOTED_ESSENTIALS.RATING_ID
        - PIVOTED_ESSENTIALS.COMPANY_ID
        - PIVOTED_ESSENTIALS.PARENT_COMPANY_ID
        - PIVOTED_ESSENTIALS.LB_RATING_ID
      column_mapping:
        Direct_RATING_ID: first(PIVOTED_ESSENTIALS.RATING_ID)
        Direct_COMPANY_ID: first(PIVOTED_ESSENTIALS.COMPANY_ID)
        Direct_PARENT_COMPANY_ID: first(PIVOTED_ESSENTIALS.PARENT_COMPANY_ID)
        Direct_LB_RATING_ID: first(PIVOTED_ESSENTIALS.LB_RATING_ID)
        Direct_TotalAssets: first(COALESCE(PIVOTED_ESSENTIALS.CorrectedTotalAssets, PIVOTED_ESSENTIALS.TotalBalanceSheet, PIVOTED_ESSENTIALS.Assets, PIVOTED_ESSENTIALS.TotalAssets))
        Direct_Turnover: first(COALESCE(PIVOTED_ESSENTIALS.TotalTurnoverTurnover, PIVOTED_ESSENTIALS.Turnover, PIVOTED_ESSENTIALS.Budget, PIVOTED_ESSENTIALS.Revenues, PIVOTED_ESSENTIALS.TotalRevenues, PIVOTED_ESSENTIALS.TotalOperatingIncome))
  
  # Step 4b: Create PARENT data for self-join (same as DIRECT but will be used as parent)
  - aggregation:
      alias: PARENT_DATA
      source: PIVOTED_ESSENTIALS
      group:
        - PIVOTED_ESSENTIALS.COMPANY_ID
        - PIVOTED_ESSENTIALS.RATING_ID
      column_mapping:
        Parent_COMPANY_ID: first(PIVOTED_ESSENTIALS.COMPANY_ID)
        Parent_RATING_ID: first(PIVOTED_ESSENTIALS.RATING_ID)
        Parent_TotalAssets: first(COALESCE(PIVOTED_ESSENTIALS.CorrectedTotalAssets, PIVOTED_ESSENTIALS.TotalBalanceSheet, PIVOTED_ESSENTIALS.Assets, PIVOTED_ESSENTIALS.TotalAssets))
        Parent_Turnover: first(COALESCE(PIVOTED_ESSENTIALS.TotalTurnoverTurnover, PIVOTED_ESSENTIALS.Turnover, PIVOTED_ESSENTIALS.Budget, PIVOTED_ESSENTIALS.Revenues, PIVOTED_ESSENTIALS.TotalRevenues, PIVOTED_ESSENTIALS.TotalOperatingIncome))
  
  # Step 5: Self join on Direct.COMPANY_ID = Parent.COMPANY_ID (corrected from PARENT_COMPANY_ID)
  - join:
      left_source: DIRECT_DATA
      right_source: PARENT_DATA
      condition:
        - DIRECT_DATA.Direct_COMPANY_ID = PARENT_DATA.Parent_COMPANY_ID
      how: left
  
  # Step 6: Prepare LBR data with calculations
  - aggregation:
      alias: LBR_CALCULATED
      source: LBR_QUANTITATIVE
      group:
        - LBR_QUANTITATIVE.LB_RATING_ID
      column_mapping:
        LBR_LB_RATING_ID: first(LBR_QUANTITATIVE.LB_RATING_ID)
        LBR_TotalAssets: first(CAST(LBR_QUANTITATIVE.TOTAL_ASSETS * 1000000000 AS STRING))
        LBR_Turnover: first(CAST((LBR_QUANTITATIVE.NET_INTEREST_YIELD + LBR_QUANTITATIVE.OTHER_OPERATING_INCOME) * 1000000000 AS STRING))
  
  # Step 7: Join with LBR data (taking all records from step 5 and any matching from LBR)
  - join:
      right_source: LBR_CALCULATED
      condition:
        - DIRECT_DATA.Direct_LB_RATING_ID = LBR_CALCULATED.LBR_LB_RATING_ID
      how: left

expressions:
  RatingID: DIRECT_DATA.Direct_RATING_ID
  ParentRatingID: PARENT_DATA.Parent_RATING_ID
  LBRatingID: LBR_CALCULATED.LBR_LB_RATING_ID
  AnnualTurnover: COALESCE(LBR_CALCULATED.LBR_Turnover, PARENT_DATA.Parent_Turnover, DIRECT_DATA.Direct_Turnover)
  AnnualTurnoverDirect: DIRECT_DATA.Direct_Turnover
  AnnualTurnoverParent: PARENT_DATA.Parent_Turnover
  AnnualTurnoverLBR: LBR_CALCULATED.LBR_Turnover
  TotalAssets: COALESCE(LBR_CALCULATED.LBR_TotalAssets, PARENT_DATA.Parent_TotalAssets, DIRECT_DATA.Direct_TotalAssets)
  TotalAssetsDirect: DIRECT_DATA.Direct_TotalAssets
  TotalAssetsParent: PARENT_DATA.Parent_TotalAssets
  TotalAssetsLBR: LBR_CALCULATED.LBR_TotalAssets

drop_duplicates: true
