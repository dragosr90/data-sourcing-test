description: This YAML processes FAIR and LBR data to produce standardized turnover and asset metrics that follow a specific hierarchy, namely LBR -> Parent company -> Direct company data.

target: bsrc_d.int_{{ RUN_MONTH }}.fair_turnover

sources:
  - alias: UCR_ACTUAL
    columns:
      - COMPANY_ID
      - RATING_ID
      - RATING_STATUS
      - PARENT_COMPANY_ID
      - LB_RATING_ID
    source: int_{{ RUN_MONTH }}.dial_fair_pd_ucr_actual
  
  - alias: PD_ITERATIONS
    columns:
      - RATING_ID
      - RECOMMENDED
      - ITERATION_NUMBER
    filter: RECOMMENDED = 'y'
    source: stg_{{ RUN_MONTH }}.dial_fair_pd_iterations
  
  - alias: MODEL_ESSENTIALS
    columns:
      - RATING_ID
      - CALCULATION_PERIOD_ID
      - MODEL_COMPONENT_ESSENTIAL_TYPE_CODE
      - MODEL_COMPONENT_ESSENTIAL_VALUE
      - MODEL_COMPONENT_ESSENTIAL_CATEGORY_VARIANT_ID
      - ITERATION_NUMBER
    filter: MODEL_COMPONENT_ESSENTIAL_TYPE_CODE IN ('CorrectedTotalAssets', 'TotalBalanceSheet', 'Assets', 'TotalAssets', 'TotalTurnover', 'Turnover', 'Budget', 'Revenues', 'TotalRevenues', 'TotalOperatingIncome') AND MODEL_COMPONENT_ESSENTIAL_CATEGORY_VARIANT_ID = 'cons'
    source: stg_{{ RUN_MONTH }}.dial_fair_pd_model_component_essentials
  
  - alias: LBR_QUANTITATIVE
    columns:
      - LB_RATING_ID
      - DATA_TYPE
      - TOTAL_ASSETS
      - NET_INTEREST_YIELD
      - OTHER_OPERATING_INCOME
    filter: DATA_TYPE = 2
    source: stg_{{ RUN_MONTH }}.dial_fair_lbr_quantitative_input

transformations:  
  # Step 1: Join recommended iterations with model essentials
  - join:
      left_source: PD_ITERATIONS
      right_source: MODEL_ESSENTIALS
      condition:
        - PD_ITERATIONS.ITERATION_NUMBER = MODEL_ESSENTIALS.ITERATION_NUMBER
        - PD_ITERATIONS.RATING_ID = MODEL_ESSENTIALS.RATING_ID
      how: inner
  
  # Step 2: Find minimum calculation period per rating
  - aggregation:
      alias: MIN_CALC_PERIODS
      group:
        - PD_ITERATIONS.RATING_ID
      column_mapping:
        MIN_CALCULATION_PERIOD_ID: min(MODEL_ESSENTIALS.CALCULATION_PERIOD_ID)
  
  # Step 3: Join back to filter only minimum calculation period records
  - join:
      left_source: MIN_CALC_PERIODS
      right_source: MODEL_ESSENTIALS
      condition:
        - MIN_CALC_PERIODS.RATING_ID = MODEL_ESSENTIALS.RATING_ID
        - MIN_CALC_PERIODS.MIN_CALCULATION_PERIOD_ID = MODEL_ESSENTIALS.CALCULATION_PERIOD_ID
      how: inner
  
  # Step 4: Join with UCR actual data - RIGHT JOIN to keep all UCR_ACTUAL records
  - join:
      right_source: UCR_ACTUAL
      condition:
        - MIN_CALC_PERIODS.RATING_ID = UCR_ACTUAL.RATING_ID
      how: right
  
  # Step 5: Aggregate model essentials by rating to get all component values
  - aggregation:
      alias: RATING_ESSENTIALS
      group:
        - UCR_ACTUAL.RATING_ID
        - UCR_ACTUAL.COMPANY_ID
        - UCR_ACTUAL.PARENT_COMPANY_ID
        - UCR_ACTUAL.LB_RATING_ID
      column_mapping:
        # Use MAX to get the value (should be unique after filtering)
        CorrectedTotalAssets: max(CASE WHEN MODEL_ESSENTIALS.MODEL_COMPONENT_ESSENTIAL_TYPE_CODE = 'CorrectedTotalAssets' THEN MODEL_ESSENTIALS.MODEL_COMPONENT_ESSENTIAL_VALUE END)
        TotalBalanceSheet: max(CASE WHEN MODEL_ESSENTIALS.MODEL_COMPONENT_ESSENTIAL_TYPE_CODE = 'TotalBalanceSheet' THEN MODEL_ESSENTIALS.MODEL_COMPONENT_ESSENTIAL_VALUE END)
        Assets: max(CASE WHEN MODEL_ESSENTIALS.MODEL_COMPONENT_ESSENTIAL_TYPE_CODE = 'Assets' THEN MODEL_ESSENTIALS.MODEL_COMPONENT_ESSENTIAL_VALUE END)
        TotalAssets: max(CASE WHEN MODEL_ESSENTIALS.MODEL_COMPONENT_ESSENTIAL_TYPE_CODE = 'TotalAssets' THEN MODEL_ESSENTIALS.MODEL_COMPONENT_ESSENTIAL_VALUE END)
        TotalTurnover: max(CASE WHEN MODEL_ESSENTIALS.MODEL_COMPONENT_ESSENTIAL_TYPE_CODE = 'TotalTurnover' THEN MODEL_ESSENTIALS.MODEL_COMPONENT_ESSENTIAL_VALUE END)
        Turnover: max(CASE WHEN MODEL_ESSENTIALS.MODEL_COMPONENT_ESSENTIAL_TYPE_CODE = 'Turnover' THEN MODEL_ESSENTIALS.MODEL_COMPONENT_ESSENTIAL_VALUE END)
        Budget: max(CASE WHEN MODEL_ESSENTIALS.MODEL_COMPONENT_ESSENTIAL_TYPE_CODE = 'Budget' THEN MODEL_ESSENTIALS.MODEL_COMPONENT_ESSENTIAL_VALUE END)
        Revenues: max(CASE WHEN MODEL_ESSENTIALS.MODEL_COMPONENT_ESSENTIAL_TYPE_CODE = 'Revenues' THEN MODEL_ESSENTIALS.MODEL_COMPONENT_ESSENTIAL_VALUE END)
        TotalRevenues: max(CASE WHEN MODEL_ESSENTIALS.MODEL_COMPONENT_ESSENTIAL_TYPE_CODE = 'TotalRevenues' THEN MODEL_ESSENTIALS.MODEL_COMPONENT_ESSENTIAL_VALUE END)
        TotalOperatingIncome: max(CASE WHEN MODEL_ESSENTIALS.MODEL_COMPONENT_ESSENTIAL_TYPE_CODE = 'TotalOperatingIncome' THEN MODEL_ESSENTIALS.MODEL_COMPONENT_ESSENTIAL_VALUE END)
        # Add the calculated fields using COALESCE for priority
        TotalAssets_calc: COALESCE(
          max(CASE WHEN MODEL_ESSENTIALS.MODEL_COMPONENT_ESSENTIAL_TYPE_CODE = 'CorrectedTotalAssets' THEN MODEL_ESSENTIALS.MODEL_COMPONENT_ESSENTIAL_VALUE END),
          max(CASE WHEN MODEL_ESSENTIALS.MODEL_COMPONENT_ESSENTIAL_TYPE_CODE = 'TotalBalanceSheet' THEN MODEL_ESSENTIALS.MODEL_COMPONENT_ESSENTIAL_VALUE END),
          max(CASE WHEN MODEL_ESSENTIALS.MODEL_COMPONENT_ESSENTIAL_TYPE_CODE = 'Assets' THEN MODEL_ESSENTIALS.MODEL_COMPONENT_ESSENTIAL_VALUE END),
          max(CASE WHEN MODEL_ESSENTIALS.MODEL_COMPONENT_ESSENTIAL_TYPE_CODE = 'TotalAssets' THEN MODEL_ESSENTIALS.MODEL_COMPONENT_ESSENTIAL_VALUE END)
        )
        Turnover_calc: COALESCE(
          max(CASE WHEN MODEL_ESSENTIALS.MODEL_COMPONENT_ESSENTIAL_TYPE_CODE = 'TotalTurnover' THEN MODEL_ESSENTIALS.MODEL_COMPONENT_ESSENTIAL_VALUE END),
          max(CASE WHEN MODEL_ESSENTIALS.MODEL_COMPONENT_ESSENTIAL_TYPE_CODE = 'Turnover' THEN MODEL_ESSENTIALS.MODEL_COMPONENT_ESSENTIAL_VALUE END),
          max(CASE WHEN MODEL_ESSENTIALS.MODEL_COMPONENT_ESSENTIAL_TYPE_CODE = 'Budget' THEN MODEL_ESSENTIALS.MODEL_COMPONENT_ESSENTIAL_VALUE END),
          max(CASE WHEN MODEL_ESSENTIALS.MODEL_COMPONENT_ESSENTIAL_TYPE_CODE = 'Revenues' THEN MODEL_ESSENTIALS.MODEL_COMPONENT_ESSENTIAL_VALUE END),
          max(CASE WHEN MODEL_ESSENTIALS.MODEL_COMPONENT_ESSENTIAL_TYPE_CODE = 'TotalRevenues' THEN MODEL_ESSENTIALS.MODEL_COMPONENT_ESSENTIAL_VALUE END),
          max(CASE WHEN MODEL_ESSENTIALS.MODEL_COMPONENT_ESSENTIAL_TYPE_CODE = 'TotalOperatingIncome' THEN MODEL_ESSENTIALS.MODEL_COMPONENT_ESSENTIAL_VALUE END)
        )
  
  # Step 6: Create parent data by aggregating by company
  - aggregation:
      alias: PARENT_DATA
      source: RATING_ESSENTIALS
      group:
        - RATING_ESSENTIALS.COMPANY_ID
      column_mapping:
        Parent_RATING_ID: max(RATING_ESSENTIALS.RATING_ID)
        Parent_TotalAssets: max(RATING_ESSENTIALS.TotalAssets_calc)
        Parent_Turnover: max(RATING_ESSENTIALS.Turnover_calc)
  
  # Step 7: Join parent data back
  - join:
      left_source: RATING_ESSENTIALS
      right_source: PARENT_DATA
      condition:
        - RATING_ESSENTIALS.PARENT_COMPANY_ID = PARENT_DATA.COMPANY_ID
      how: left
  
  # Step 8: Join with LBR data
  - join:
      right_source: LBR_QUANTITATIVE
      condition:
        - RATING_ESSENTIALS.LB_RATING_ID = LBR_QUANTITATIVE.LB_RATING_ID
      how: left

expressions:
  RatingID: RATING_ESSENTIALS.RATING_ID
  ParentRatingID: PARENT_DATA.Parent_RATING_ID
  LBRatingID: RATING_ESSENTIALS.LB_RATING_ID
  # Hierarchy: LBR → Parent → Direct
  AnnualTurnover: COALESCE(
    CASE WHEN LBR_QUANTITATIVE.NET_INTEREST_YIELD IS NOT NULL AND LBR_QUANTITATIVE.OTHER_OPERATING_INCOME IS NOT NULL 
    THEN CAST((LBR_QUANTITATIVE.NET_INTEREST_YIELD + LBR_QUANTITATIVE.OTHER_OPERATING_INCOME) * 1000000000 AS STRING) END,
    CAST(PARENT_DATA.Parent_Turnover AS STRING),
    CAST(RATING_ESSENTIALS.Turnover_calc AS STRING)
  )
  AnnualTurnoverDirect: CAST(RATING_ESSENTIALS.Turnover_calc AS STRING)
  AnnualTurnoverParent: CAST(PARENT_DATA.Parent_Turnover AS STRING)
  AnnualTurnoverLBR: CASE WHEN LBR_QUANTITATIVE.NET_INTEREST_YIELD IS NOT NULL AND LBR_QUANTITATIVE.OTHER_OPERATING_INCOME IS NOT NULL THEN CAST((LBR_QUANTITATIVE.NET_INTEREST_YIELD + LBR_QUANTITATIVE.OTHER_OPERATING_INCOME) * 1000000000 AS STRING) END
  TotalAssets: COALESCE(
    CASE WHEN LBR_QUANTITATIVE.TOTAL_ASSETS IS NOT NULL 
    THEN CAST(LBR_QUANTITATIVE.TOTAL_ASSETS * 1000000000 AS STRING) END,
    CAST(PARENT_DATA.Parent_TotalAssets AS STRING),
    CAST(RATING_ESSENTIALS.TotalAssets_calc AS STRING)
  )
  TotalAssetsDirect: CAST(RATING_ESSENTIALS.TotalAssets_calc AS STRING)
  TotalAssetsParent: CAST(PARENT_DATA.Parent_TotalAssets AS STRING)
  TotalAssetsLBR: CASE WHEN LBR_QUANTITATIVE.TOTAL_ASSETS IS NOT NULL THEN CAST(LBR_QUANTITATIVE.TOTAL_ASSETS * 1000000000 AS STRING) END

drop_duplicates: true
