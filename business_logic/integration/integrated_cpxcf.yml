target: int_{{ RUN_MONTH }}.{{ DELIVERY_ENTITY }}_integrated_cpxcf

sources:
  - alias: DUMMY
    columns:
    - AlternativeLocalReferenceIdentifier
    - SourceSystemIdentifier
    - DeliveryEntity
    - ReportingDate
    - LocalFacilityIdentifier
    source: int_{{ RUN_MONTH }}.{{ DELIVERY_ENTITY }}_dummy_facility
  - alias: SSF_CPXCA
    columns:
    - CurrentAccount
    - CurrentAccountSourceSystemIdentifier
    - DeliveryEntity
    - ReportingDate
    - ParticipatingCounterparty
    - ParticipatingCounterpartySourceSystemIdentifier
    source: stg_{{ RUN_MONTH }}.ssf_{{ DELIVERY_ENTITY }}_cpxca
  - alias: SSF_CPXCF
    columns:
    - DeliveryEntity
    - ReportingDate
    - CounterpartyRole
    - CreditFacility
    - CreditFacilitySourceSystemIdentifier
    - LiabilityPercentage
    - ParticipatingCounterparty
    - ParticipatingCounterpartySourceSystemIdentifier
    source: stg_{{ RUN_MONTH }}.ssf_{{ DELIVERY_ENTITY }}_cpxcf


transformations:
  - join:
      alias: DUMMY_CPXCF_TEMP
      left_source: SSF_CPXCA
      right_source: DUMMY
      condition:
        - SSF_CPXCA.CurrentAccount = DUMMY.AlternativeLocalReferenceIdentifier
        - SSF_CPXCA.CurrentAccountSourceSystemIdentifier = DUMMY.SourceSystemIdentifier
      how: inner
  - add_variables:
      alias: DUMMY_CPXCF
      source: DUMMY_CPXCF_TEMP
      column_mapping:
        SrcDeliveryEntity: DUMMY_CPXCF_TEMP.DeliveryEntity
        SrcReportingDate: DUMMY_CPXCF_TEMP.ReportingDate
        SrcCounterpartyRole: CAST(NULL AS STRING)
        SrcCreditFacility: DUMMY_CPXCF_TEMP.LocalFacilityIdentifier
        SrcCreditFacilitySourceSystemIdentifier: DUMMY_CPXCF_TEMP.CurrentAccountSourceSystemIdentifier
        SrcLiabilityPercentage: CAST(NULL AS STRING)
        SrcParticipatingCounterparty: DUMMY_CPXCF_TEMP.ParticipatingCounterparty
        SrcParticipatingCounterpartySourceSystemIdentifier: DUMMY_CPXCF_TEMP.ParticipatingCounterpartySourceSystemIdentifier
  - union:
      alias: COMBINED_CPXCF
      column_mapping:
        DUMMY_CPXCF:
          DeliveryEntity: SrcDeliveryEntity
          ReportingDate: SrcReportingDate
          CounterpartyRole: SrcCounterpartyRole
          CreditFacility: SrcCreditFacility
          CreditFacilitySourceSystemIdentifier: SrcCreditFacilitySourceSystemIdentifier
          LiabilityPercentage: SrcLiabilityPercentage
          ParticipatingCounterparty: SrcParticipatingCounterparty
          ParticipatingCounterpartySourceSystemIdentifier: SrcParticipatingCounterpartySourceSystemIdentifier
        SSF_CPXCF:
          DeliveryEntity: DeliveryEntity
          ReportingDate: ReportingDate
          CounterpartyRole: CounterpartyRole
          CreditFacility: CreditFacility
          CreditFacilitySourceSystemIdentifier: CreditFacilitySourceSystemIdentifier
          LiabilityPercentage: LiabilityPercentage
          ParticipatingCounterparty: ParticipatingCounterparty
          ParticipatingCounterpartySourceSystemIdentifier: ParticipatingCounterpartySourceSystemIdentifier

expressions:
  DeliveryEntity: COMBINED_CPXCF.DeliveryEntity
  ReportingDate: COMBINED_CPXCF.ReportingDate
  CounterpartyRole: COMBINED_CPXCF.CounterpartyRole
  CreditFacility: COMBINED_CPXCF.CreditFacility
  CreditFacilitySourceSystemIdentifier: COMBINED_CPXCF.CreditFacilitySourceSystemIdentifier
  LiabilityPercentage: CAST(NULL AS STRING)
  ParticipatingCounterparty: COMBINED_CPXCF.ParticipatingCounterparty
  ParticipatingCounterpartySourceSystemIdentifier: COMBINED_CPXCF.ParticipatingCounterpartySourceSystemIdentifier

drop_duplicates: true
