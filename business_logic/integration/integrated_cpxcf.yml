target: int_{{ RUN_MONTH }}.{{ DELIVERY_ENTITY }}_integrated_cpxcf

sources:
  - alias: DUMMY
    columns:
      - DeliveryEntity
      - ReportingDate
      - AlternativeLocalReferenceIdentifier
      - LocalFacilityIdentifier
      - SourceSystemIdentifier
    source: int_{{ RUN_MONTH }}.{{ DELIVERY_ENTITY }}_dummy_facility
  - alias: SSF_CPXCA
    columns:
      - DeliveryEntity
      - ReportingDate
      - CounterpartyRole
      - CurrentAccount
      - CurrentAccountSourceSystemIdentifier
      - ParticipatingCounterparty
      - ParticipatingCounterpartySourceSystemIdentifier
    source: stg_{{ RUN_MONTH }}.ssf_{{ DELIVERY_ENTITY }}_cpxca
  - alias: SSF_CPXCF
    columns:
      - DeliveryEntity
      - ReportingDate
      - CounterpartyRole
      - CreditFacility
      - CreditFacilitySourceSystemIdentifier
      - LiabilityPercentage
      - ParticipatingCounterparty
      - ParticipatingCounterpartySourceSystemIdentifier
    source: stg_{{ RUN_MONTH }}.ssf_{{ DELIVERY_ENTITY }}_cpxcf

transformations:
  # First, select only the columns we need from SSF_CPXCA with explicit renaming to avoid ambiguity
  - add_variables:
      alias: SSF_CPXCA_SELECTED
      source: SSF_CPXCA
      column_mapping:
        DeliveryEntity_CPXCA: SSF_CPXCA.DeliveryEntity
        ReportingDate_CPXCA: SSF_CPXCA.ReportingDate
        CounterpartyRole: SSF_CPXCA.CounterpartyRole
        CurrentAccount: SSF_CPXCA.CurrentAccount
        CurrentAccountSourceSystemIdentifier: SSF_CPXCA.CurrentAccountSourceSystemIdentifier
        ParticipatingCounterparty: SSF_CPXCA.ParticipatingCounterparty
        ParticipatingCounterpartySourceSystemIdentifier: SSF_CPXCA.ParticipatingCounterpartySourceSystemIdentifier
  
  # Similarly, select columns from DUMMY with explicit renaming
  - add_variables:
      alias: DUMMY_SELECTED
      source: DUMMY
      column_mapping:
        DeliveryEntity_DUMMY: DUMMY.DeliveryEntity
        ReportingDate_DUMMY: DUMMY.ReportingDate
        AlternativeLocalReferenceIdentifier: DUMMY.AlternativeLocalReferenceIdentifier
        LocalFacilityIdentifier: DUMMY.LocalFacilityIdentifier
        SourceSystemIdentifier: DUMMY.SourceSystemIdentifier
  
  # Join the cleaned datasets to avoid column name ambiguity
  - join:
      alias: DUMMY_CPXCF
      left_source: SSF_CPXCA_SELECTED
      right_source: DUMMY_SELECTED
      condition:
        - SSF_CPXCA_SELECTED.CurrentAccount = DUMMY_SELECTED.AlternativeLocalReferenceIdentifier AND
          SSF_CPXCA_SELECTED.CurrentAccountSourceSystemIdentifier = DUMMY_SELECTED.SourceSystemIdentifier
      how: inner
  
  # Now add computed columns and create a clean dataset for union
  - add_variables:
      alias: DUMMY_CPXCF_FINAL
      source: DUMMY_CPXCF
      column_mapping:
        DeliveryEntity: DeliveryEntity_CPXCA  # Use CPXCA as the source of truth
        ReportingDate: ReportingDate_CPXCA    # Use CPXCA as the source of truth
        CounterpartyRole: CounterpartyRole
        CreditFacility: LocalFacilityIdentifier
        CreditFacilitySourceSystemIdentifier: CurrentAccountSourceSystemIdentifier
        LiabilityPercentage: CAST(NULL AS STRING)
        ParticipatingCounterparty: ParticipatingCounterparty
        ParticipatingCounterpartySourceSystemIdentifier: ParticipatingCounterpartySourceSystemIdentifier
  
  # Union with the final clean dataset
  - union:
      alias: COMBINED_CPXCF
      column_mapping:
        DUMMY_CPXCF_FINAL:
          DeliveryEntity: DeliveryEntity
          ReportingDate: ReportingDate
          CounterpartyRole: CounterpartyRole
          CreditFacility: CreditFacility
          CreditFacilitySourceSystemIdentifier: CreditFacilitySourceSystemIdentifier
          LiabilityPercentage: LiabilityPercentage
          ParticipatingCounterparty: ParticipatingCounterparty
          ParticipatingCounterpartySourceSystemIdentifier: ParticipatingCounterpartySourceSystemIdentifier
        SSF_CPXCF:
          DeliveryEntity: DeliveryEntity
          ReportingDate: ReportingDate
          CounterpartyRole: CounterpartyRole
          CreditFacility: CreditFacility
          CreditFacilitySourceSystemIdentifier: CreditFacilitySourceSystemIdentifier
          LiabilityPercentage: LiabilityPercentage
          ParticipatingCounterparty: ParticipatingCounterparty
          ParticipatingCounterpartySourceSystemIdentifier: ParticipatingCounterpartySourceSystemIdentifier

expressions:
  DeliveryEntity: COMBINED_CPXCF.DeliveryEntity
  ReportingDate: COMBINED_CPXCF.ReportingDate
  CounterpartyRole: COMBINED_CPXCF.CounterpartyRole
  CreditFacility: COMBINED_CPXCF.CreditFacility
  CreditFacilitySourceSystemIdentifier: COMBINED_CPXCF.CreditFacilitySourceSystemIdentifier
  LiabilityPercentage: COMBINED_CPXCF.LiabilityPercentage
  ParticipatingCounterparty: COMBINED_CPXCF.ParticipatingCounterparty
  ParticipatingCounterpartySourceSystemIdentifier: COMBINED_CPXCF.ParticipatingCounterpartySourceSystemIdentifier

drop_duplicates: true
