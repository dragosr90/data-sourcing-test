-- 1. Check why records have "None" source
-- These are records in UCR_ACTUAL but no data from MODEL_ESSENTIALS or LBR

SELECT 
    'Records with None source analysis' as check_type,
    COUNT(DISTINCT f.RatingID) as total_none_records,
    COUNT(DISTINCT CASE WHEN r.TotalTurnover IS NOT NULL THEN f.RatingID END) as none_records_with_rdf_data,
    COUNT(DISTINCT CASE WHEN r.TotalTurnover IS NULL THEN f.RatingID END) as none_records_without_rdf_data
FROM fair_turnover f
LEFT JOIN rdf_table r ON f.RatingID = r.RatingID  
WHERE f.TurnoverSource = 'None';

-- 2. Check PD_ITERATIONS coverage
-- How many UCR records have recommended iterations?

SELECT 
    'PD_ITERATIONS coverage' as check_type,
    COUNT(DISTINCT u.RATING_ID) as total_ucr_records,
    COUNT(DISTINCT p.RATING_ID) as records_with_iterations,
    COUNT(DISTINCT u.RATING_ID) - COUNT(DISTINCT p.RATING_ID) as records_without_iterations
FROM int_{{ RUN_MONTH }}.pd_ucr_actual u
LEFT JOIN stg_{{ RUN_MONTH }}.dial_fair_pd_iterations p 
    ON u.RATING_ID = p.RATING_ID 
    AND p.RECOMMENDED = 'y';

-- 3. Check MODEL_ESSENTIALS coverage for records with iterations

SELECT 
    'MODEL_ESSENTIALS coverage' as check_type,
    COUNT(DISTINCT p.RATING_ID) as records_with_iterations,
    COUNT(DISTINCT m.RATING_ID) as records_with_model_data,
    COUNT(DISTINCT p.RATING_ID) - COUNT(DISTINCT m.RATING_ID) as iterations_without_model_data
FROM stg_{{ RUN_MONTH }}.dial_fair_pd_iterations p
LEFT JOIN stg_{{ RUN_MONTH }}.dial_fair_pd_model_component_essentials m
    ON p.RATING_ID = m.RATING_ID 
    AND p.ITERATION_NUMBER = m.ITERATION_NUMBER
WHERE p.RECOMMENDED = 'y'
    AND m.MODEL_COMPONENT_ESSENTIAL_TYPE_CODE IN ('CorrectedTotalAssets', 'TotalBalanceSheet', 'Assets', 'TotalAssets', 'TotalTurnoverTurnover', 'Turnover', 'Budget', 'Revenues', 'TotalRevenues', 'TotalOperatingIncome')
    AND m.MODEL_COMPONENT_ESSENTIAL_CATEGORY_VARIANT_ID = 'cons';

-- 4. Sample records with "None" source that have RDF data
-- These are the problematic ones we need to understand

SELECT 
    f.RatingID,
    f.TurnoverSource,
    f.AnnualTurnover as FAIR_Turnover,
    r.TotalTurnover as RDF_Turnover,
    u.COMPANY_ID,
    u.LB_RATING_ID,
    CASE WHEN p.RATING_ID IS NOT NULL THEN 'Has Iterations' ELSE 'No Iterations' END as Iteration_Status
FROM fair_turnover f
JOIN rdf_table r ON f.RatingID = r.RatingID
JOIN int_{{ RUN_MONTH }}.pd_ucr_actual u ON f.RatingID = u.RATING_ID
LEFT JOIN stg_{{ RUN_MONTH }}.dial_fair_pd_iterations p 
    ON f.RatingID = p.RATING_ID AND p.RECOMMENDED = 'y'
WHERE f.TurnoverSource = 'None' 
    AND r.TotalTurnover IS NOT NULL
LIMIT 20;

-- 5. Check if RDF might be using non-recommended iterations or different filters

SELECT 
    'Check different iteration filters' as check_type,
    RECOMMENDED,
    COUNT(DISTINCT RATING_ID) as rating_count,
    COUNT(*) as total_iterations
FROM stg_{{ RUN_MONTH }}.dial_fair_pd_iterations
GROUP BY RECOMMENDED;

-- 6. Check if there's another source table RDF might be using
-- Look for records in RDF that don't have model essentials in FAIR

SELECT 
    'RDF records without FAIR model data' as check_type,
    COUNT(DISTINCT r.RatingID) as total_rdf_records,
    COUNT(DISTINCT CASE WHEN f.TurnoverSource = 'Direct' THEN r.RatingID END) as rdf_with_fair_direct,
    COUNT(DISTINCT CASE WHEN f.TurnoverSource = 'LBR' THEN r.RatingID END) as rdf_with_fair_lbr,
    COUNT(DISTINCT CASE WHEN f.TurnoverSource = 'None' THEN r.RatingID END) as rdf_with_fair_none
FROM rdf_table r
LEFT JOIN fair_turnover f ON r.RatingID = f.RatingID
WHERE r.TotalTurnover IS NOT NULL;
