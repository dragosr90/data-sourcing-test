description: This YAML creates TINE NPL and PL ,enter like 2 Files, created from tgt_exposure and to be shared with calculation and Reporting application after converting into parquet format. This structure is as per August release (test env) 

target: dist_{{ RUN_MONTH }}.tine_npl_lending_expo_agmt

sources:
  - alias: EXP
    filter: PlNplIndicator = 'NPL'
    source: dist_{{ RUN_MONTH }}.tgt_exposure
  
expressions:
  LENDING_EXPO_AGMT_ID: concat(coalesce (BaselSSC,'AZ1'),EXP.ExposureID)
    #case when BaselSSC is null then concat('AZ1', EXP.ExposureID) else concat(BaselSSC, EXP.ExposureID) end
    #to handle null ssc scenario temporarily. AZ1 is default value. concat(BaselSSC, EXP.ExposureID)
  ASSET_SEC_REF_ID: EXP.SecuritisationIdentifier
  CPTY_ID: >
        concat(case when CounterpartySourceSystemIdentifier = 'AAB.SYS.1861' then 'FB1' when BaselSSC is not null then BaselSSC else 'AZ1' end,EXP.CounterpartyID)
  CREDIT_FAC_AGMT_ID: concat(coalesce (BaselSSC,'AZ1'),EXP.CreditFacilityID)
  ULTIMATE_CREDIT_FAC_AGMT_ID: CAST(NULL AS STRING)
  EXEMPTION_CLAIM_CONDITION_ID: EXP.ExemptionClaimConditionIDRC
  EXEMPTION_TYPE: EXP.ExemptionType
  REPORTING_DATE: EXP.ReportingDate
  BOOK_TYPE: CAST(NULL AS STRING)
  AR_PARTICIPATION_TYPE: CAST(NULL AS STRING)
  AR_FINANCIAL_STATUS_TYPE: CAST(NULL AS STRING)
  BASEL_PRODUCT_TYPE: EXP.BaselProductType
  AR_START_DATE: EXP.TradeDate
  MATURITY_DATE: CAST(EXP.MaturityDate AS DATE)
  LEGAL_ENTITY_OF_THE_BANK: CAST(NULL AS STRING)
  REPORTING_ENTITY: EXP.ReportingEntity
  BUSINESS_SEGMENT_LEVEL_4: CAST(NULL AS STRING)
  BUSINESS_SEGMENT_LEVEL_3: EXP.BusinessSegmentLevel3
  MAGNITUDE_KEY: EXP.MagnitudeKey
  SUBORDINATION_TYPE: EXP.SubordinationType
  AR_LIFE_CYCLE_STATUS_TYPE: >
                          case
                           when EXP.ContractStatus = 'MATURED' then 'Completed Arrangement' 
                           When  EXP.ContractStatus = 'OFFACS' then 'Accepted Arrangement' 
                           else 'Effective Arrangement' 
                          end
  IMPAIRED_FLAG: CAST(NULL AS INTEGER)
  IMPAIRED_STATUS_CODE: CAST(NULL AS STRING)
  DATE_OF_IMPAIRMENT: CAST(NULL AS DATE)
  CREDIT_RISK_APPROACH_TYPE: >
                          case 
                            when EXP.RiskWeightedExposureApproachRC = 'SA' then 'STD_NR'
                            when EXP.RiskWeightedExposureApproachRC = 'FIRB' then 'IRB_FOUND_NR'
                            when EXP.RiskWeightedExposureApproachRC = 'AIRB' then 'IRB_ADV_NR'
                          end
  TECHINICAL_KEY_SEGMENT: CAST(NULL AS STRING)
  REVOLVING_PRODUCT_FLAG: >
                        case
                          when EXP.RevolvingProductFlag = 'Y' then 1
                          else 0
                        end
  LEASE_PRODUCT_FLAG: >
                        case
                          when EXP.LeaseProductFlag = 'Y' then 1
                          else 0
                        end 
  OFF_BALANCE_PRODUCT_FLAG: >
                        case
                          when EXP.OffBalanceProductFlag = 'Y' then 1
                          else 0
                        end 
  ASSET_SEC_INVOLVEMENT_TYPE: EXP.SecuritisationRoleType
  PROCESS_FILTER_CODE: EXP.BaselProcessFilterCode
  LOCAL_PRODUCT: CAST(NULL AS STRING)
  BO_NUMBER: CAST(NULL AS STRING)
  EFFECTIVE_MATURITY: EXP.EffectiveMaturity
  SECZ_ASSET_PERCENTAGE: CAST(NULL AS DOUBLE)
  LOCAL_COA: CAST(NULL AS STRING)
  REPORTING_COA: EXP.ReportingCOA
  MEASUREMENT_CCY: CAST(NULL AS STRING)
  ORIGINAL_CCY: EXP.TransactionCurrency
  NET_PRESENT_VALUE: >
                  case
                    when EXP.LeaseProductFlag = 'Y' then EXP.OutstandingAmount
                  end
  EXCHANGE_RATE_TO_ORIGINAL_CCY: EXP.CurrencyExchangeRate
  BARGAIN_OPTION_VALUE: CAST(NULL AS DOUBLE)
  RESIDUAL_VALUE: EXP.ResidualValueOperationalLeaseReportingAmount
  PRINCIPAL_AMOUNT: EXP.OutstandingAmount
  ACCRUED_FEES: CAST(NULL AS DOUBLE)
    #EXP.AccruedFeesAmountReportingAmount - decided to keep null
  ACCRUED_INTEREST: CAST(NULL AS DOUBLE)
    #EXP.AccruedInterestAmountReportingAmount - decided to keep null
  PRE_CALCULATED_EAD: CAST(NULL AS DOUBLE)
  WRITE_OFF_AMOUNT: EXP.TechnicalWriteoffReportingAmount
  RAY_PREFIX: CAST(NULL AS STRING)
  TIME_STAMP: CURRENT_TIMESTAMP
  SOURCE_SYSTEM: CAST(NULL AS STRING)
  LENDING_EXPO_AGMT_UID: EXP.ExposureID
  LENDING_EXPO_AGMT_SSC: coalesce(EXP.BaselSSC, 'AZ1')
  CPTY_UID: EXP.CounterpartyID
  CPTY_SSC: >
        case 
          when CounterpartySourceSystemIdentifier = 'AAB.SYS.1861' then 'FB1'
          when  BaselSSC is not null then BaselSSC
          else 'AZ1'
        end
    #coalesce(EXP.BaselSSC, 'AZ1')
  # add new logic as per cfac ssc
  CREDIT_FAC_AGMT_UID: EXP.CreditFacilityID
  CREDIT_FAC_AGMT_SSC: coalesce(EXP.BaselSSC, 'AZ1')
  ULTIMATE_CREDIT_FAC_AGMT_UID: CAST(NULL AS STRING)
  ULTIMATE_CREDIT_FAC_AGMT_SSC: CAST(NULL AS STRING)
  AR_END_DATE: CAST(NULL AS DATE)
  ORIGINAL_LENDING_EXPO_AGMT_ID: CAST(NULL AS STRING)
  BUSINESS_SEGMENT_LEVEL_5: CAST(NULL AS STRING)
  ELIGIBLE_MIN_RESERVE_IND: CAST(NULL AS STRING)
  EAD_MODEL: CAST(NULL AS STRING)
  MANAGING_ENTITY: CAST(NULL AS STRING)
  NUMBER_OF_DAYS_IN_DELINQUENCY: CAST(NULL AS INTEGER)
  PRE_CALCULATED_EAD_PORTFOLIO: CAST(NULL AS STRING)
  ASSET_PURCHASED_IN_DEFAULT_AMT: CAST(NULL AS DOUBLE)
  ASSET_PURCHASED_IN_DEFAULT_IND: CAST(NULL AS STRING)
  DELIVERY_ENTITY: EXP.DeliveryEntity
  ALLOWANCE_TYPE: CAST(NULL AS STRING)
  IFRS9_RISK_STAGE: EXP.Ifrs9RiskStage
  LEDGER_WRITEOFF_AMOUNT: CAST(NULL AS DOUBLE)
  LEDGER_WRITEOFF_RCOA: CAST(NULL AS STRING)
  LEDGER_WRITEOFF_T_AMOUNT: CAST(NULL AS DOUBLE)
  LEDGER_WRITEOFF_T_CCY: CAST(NULL AS STRING)
  LOAN_LOSS_ALLOWANCE_AMOUNT: EXP.LoanLossAllowanceReportingAmount
  LOAN_LOSS_ALLOWANCE_RCOA: EXP.LoanLossAllowanceRcoa
  LOAN_LOSS_ALLOWANCE_T_AMOUNT: CAST(NULL AS DOUBLE)
  LOAN_LOSS_ALLOWANCE_T_CCY: CAST(NULL AS STRING)
  WRITEOFF_AMOUNT: CAST(NULL AS DOUBLE)
  WRITEOFF_RCOA: CAST(NULL AS STRING)
  WRITEOFF_T_AMOUNT: CAST(NULL AS DOUBLE)
  WRITEOFF_T_CCY: CAST(NULL AS STRING)
  DATEOFSECURITISATION: EXP.DateOfSecuritisation
  SECURITISATIONTYPE: EXP.SecuritisationType
  ACCUMULATEDWRITEOFFRCOA: CAST(NULL AS STRING)
  ACCUMULATEDWRITEOFFRAMNT: EXP.AccumulatedTechnicalWriteoffReportingAmount
  ACCUMULATEDWRITEOFFTAMNT: CAST(NULL AS DOUBLE)
  ACCUMULATEDWRITEOFFTCURR: CAST(NULL AS STRING)
  FORBEARANCEMEASURE: EXP.ForbearanceMeasure
  FORBEARANCEMEASUREAPPROVALDATE: EXP.ForbearanceMeasureApprovalDate
  FORBEARANCEMEASUREENDDATE: CAST(NULL AS DATE)
  FORBEARANCEMEASURETYPE: CAST(NULL AS STRING)
  DEFAULTDATE: CAST(NULL AS DATE)
  DEFAULTENDDATE: CAST(NULL AS DATE)
  NONPERFORMINGENDDATE: CAST(NULL AS DATE)
  NONPERFORMINGSTARTDATE: EXP.NonPerformingStartDate
  PERFORMINGINDICATOR: CAST(NULL AS STRING)
  CARRYINGAMOUNTRCOA: CAST(NULL AS STRING)
  CARRYINGAMOUNTRAMNT: CAST(NULL AS DOUBLE)
  CARRYINGAMOUNTTAMNT: CAST(NULL AS DOUBLE)
  CARRYINGAMOUNTTCURR: CAST(NULL AS STRING)
  NOMINALAMOUNTRCOA: CAST(NULL AS STRING)
  NOMINALAMOUNTRAMNT: CAST(NULL AS DOUBLE)
  NOMINALAMOUNTTAMNT: CAST(NULL AS DOUBLE)
  NOMINALAMOUNTTCURR: CAST(NULL AS STRING)
  FIRST_FORBEARANCE_FLG: CAST(NULL AS STRING)
  ACCRUED_FEE_PAYABLE: CAST(NULL AS DOUBLE)
  ACCRUED_FEE_RECEIVABLE: CAST(NULL AS DOUBLE)
  FUTURE_FEE_AMOUNT: CAST(NULL AS DOUBLE)
  ACCRUED_INTEREST_PAYABLE: CAST(NULL AS DOUBLE)
  ACCRUED_INTEREST_RECEIVABLE: CAST(NULL AS DOUBLE)
  FIN_PACKAGE_IDENTIFIER: CAST(NULL AS STRING)
  CONTRACT_ID: CAST(NULL AS STRING)
  FIN_MARKET_INST: CAST(NULL AS STRING)
  TRADE_MATCH_STATUS: CAST(NULL AS STRING)
  MASTER_BOOK_CODE: CAST(NULL AS STRING)
  CNTRCT_INT_RATE_CR: CAST(NULL AS DOUBLE)
  CNTRCT_INT_RATE_DR: CAST(NULL AS DOUBLE)
  EFFEC_INT_RATE_CR: CAST(NULL AS DOUBLE)
  EFFEC_INT_RATE_DR: CAST(NULL AS DOUBLE)
  RISK_NOTIONAL_AMOUNT: CAST(NULL AS DOUBLE)
  DISCOUNT_PREMIUM_AMT: CAST(NULL AS DOUBLE)
  CLOSING_EAD: CAST(NULL AS DOUBLE)
  NOTIONAL_AMOUNT: CAST(NULL AS DOUBLE)
  BEM_NETTING_AMOUNT: CAST(NULL AS DOUBLE)
  BALANCE_POSTED_AMOUNT: CAST(NULL AS DOUBLE)
  BALANCE_NET_AMOUNT: CAST(NULL AS DOUBLE)
  PFE_PERCENTAGE: CAST(NULL AS DOUBLE)
  PRECALC_NETTING_PROVIDED_AMT: CAST(NULL AS DOUBLE)
  REPLACEMENT_COST_CLEAN: CAST(NULL AS DOUBLE)
  REPLACEMENT_COST_DIRTY: CAST(NULL AS DOUBLE)
  SUBORDINATION_PROXY_FLAG: CAST(NULL AS STRING)
  SUBJCOVID19PUBLICGUARSCHSTAT: CAST(NULL AS STRING)
  INTEREST_RATE_EFFECTIVE_DATE: CAST(NULL AS DATE)
  INTEREST_RATE_END_DATE: CAST(NULL AS DATE)
  MORTGAGE_PRODUCT_FLAG: CAST(NULL AS INTEGER)
  DEBITCREDITINDICATOR: EXP.DebitCreditIndicator
  QRRETRANSACTOR: EXP.QRRETransactor
  SOURCED_EXEMPTION_ID: EXP.SourcedExemptionID
  REVOLVINGINDICATOR: >
                  case
                    when EXP.RevolvingFlag = 'Y' then 1
                    else 0
                  end 
  HEDGED_EXP_FLG: CAST(NULL AS STRING)
  INDIRECTLY_FINANCING_ADC_EXP: CAST(NULL AS STRING)
  CPTY_PRODUCT_PURPOSE: CAST(NULL AS STRING)
  INSTALLMENT_PRINCIPAL_AMT: CAST(NULL AS DOUBLE)
  INSTALLMENT_INTEREST_AMT: CAST(NULL AS DOUBLE)
  EFFECTIVE_MATURITY_DATE: EXP.EffectiveMaturityDateCRR
  TRADE_DATE: EXP.TradeDate
  SETTLEMENT_DATE: EXP.SettlementDate
  EC_CREDIT_RISK_APPROACH_TYPE: EXP.RiskWeightedExposureApproachEC
  EC_EXEMPTION_CLAIM_CONDITION_ID: CAST(EXP.ExemptionClaimConditionIDEC as integer)
  SSF_ARRANGEMENTIDENTIFIER: CAST(NULL AS STRING)
  SSF_SOURCESYSTEMIDENTIFIER: CAST(NULL AS STRING)
